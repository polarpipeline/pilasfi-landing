<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PilasFi - Documentación Técnica Completa</title>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* ========================================
           PILASFI DOCS - Inspired by Zelle + MetaMask + Stripe
           Premium Dark Mode with Animated Gradients
           ======================================== */

        :root {
            /* Zelle Purple + MetaMask Orange Palette */
            --zelle-purple: #6D1ED4;
            --zelle-purple-light: #8B5CF6;
            --zelle-purple-dark: #4C1D95;
            --metamask-orange: #F6851B;
            --metamask-orange-light: #FFB347;
            --stripe-blue: #635BFF;

            /* Core Colors */
            --bg-primary: #0A0A0F;
            --bg-secondary: #12121A;
            --bg-tertiary: #1A1A25;
            --bg-card: rgba(26, 26, 37, 0.7);

            /* Glass Effect */
            --glass-bg: rgba(109, 30, 212, 0.08);
            --glass-border: rgba(139, 92, 246, 0.2);
            --glass-shadow: 0 8px 32px rgba(109, 30, 212, 0.15);

            /* Text */
            --text-primary: #FFFFFF;
            --text-secondary: #A1A1AA;
            --text-muted: #71717A;

            /* Accent Colors */
            --accent-success: #10B981;
            --accent-warning: #F59E0B;
            --accent-error: #EF4444;
            --accent-info: #3B82F6;

            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--zelle-purple) 0%, var(--metamask-orange) 100%);
            --gradient-subtle: linear-gradient(135deg, rgba(109, 30, 212, 0.2) 0%, rgba(246, 133, 27, 0.1) 100%);
            --gradient-glow: radial-gradient(ellipse at center, rgba(109, 30, 212, 0.3) 0%, transparent 70%);

            /* Borders */
            --border-color: rgba(139, 92, 246, 0.15);
            --border-hover: rgba(139, 92, 246, 0.4);

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========================================
           ANIMATED MESH GRADIENT BACKGROUND (Stripe-style)
           ======================================== */
        .gradient-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            overflow: hidden;
        }

        .gradient-bg::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(ellipse 80% 50% at 20% 40%, rgba(109, 30, 212, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 20%, rgba(246, 133, 27, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse 50% 60% at 40% 80%, rgba(99, 91, 255, 0.25) 0%, transparent 50%),
                radial-gradient(ellipse 70% 50% at 70% 60%, rgba(139, 92, 246, 0.2) 0%, transparent 50%);
            animation: gradientMove 20s ease-in-out infinite;
        }

        .gradient-bg::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 30% 70%, rgba(246, 133, 27, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 70% 30%, rgba(109, 30, 212, 0.2) 0%, transparent 40%);
            animation: gradientPulse 15s ease-in-out infinite alternate;
        }

        @keyframes gradientMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(2%, 2%) rotate(1deg); }
            50% { transform: translate(-1%, 3%) rotate(-1deg); }
            75% { transform: translate(3%, -2%) rotate(2deg); }
        }

        @keyframes gradientPulse {
            0% { opacity: 0.6; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.1); }
        }

        /* Noise overlay for texture */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        /* ========================================
           LAYOUT
           ======================================== */
        .container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* ========================================
           GLASSMORPHISM SIDEBAR
           ======================================== */
        .sidebar {
            width: 300px;
            background: rgba(18, 18, 26, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 24px 0;
            z-index: 100;
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .sidebar:hover {
            box-shadow: 4px 0 40px rgba(109, 30, 212, 0.1);
        }

        /* Custom Scrollbar */
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: transparent; }
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 3px;
        }
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--zelle-purple-light);
        }

        .sidebar-header {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        .sidebar-header h1 {
            font-size: 22px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .sidebar-header .version {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .nav-section { padding: 12px 16px; }

        .nav-section-title {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--zelle-purple-light);
            margin-bottom: 12px;
            letter-spacing: 1.5px;
            font-weight: 700;
            padding: 0 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 4px;
            font-size: 13px;
            font-weight: 500;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--gradient-primary);
            transform: scaleY(0);
            transition: transform var(--transition-fast);
            border-radius: 0 2px 2px 0;
        }

        .nav-link:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .nav-link:hover::before {
            transform: scaleY(1);
        }

        /* ========================================
           MAIN CONTENT
           ======================================== */
        .main-content {
            margin-left: 300px;
            flex: 1;
            padding: 48px 56px;
            max-width: 1200px;
            position: relative;
        }

        /* ========================================
           PAGE HEADER - Hero Style
           ======================================== */
        .page-header {
            margin-bottom: 56px;
            padding-bottom: 40px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .page-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 120px;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }

        .page-header h1 {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #FFFFFF 0%, var(--zelle-purple-light) 50%, var(--metamask-orange) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.03em;
            line-height: 1.2;
        }

        .page-header .meta {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.8;
        }

        /* ========================================
           SECTIONS
           ======================================== */
        .section {
            margin-bottom: 64px;
            animation: fadeInUp 0.6s ease backwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-bottom: 16px;
            position: relative;
            letter-spacing: -0.02em;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }

        h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 32px 0 16px;
            color: var(--zelle-purple-light);
            letter-spacing: -0.01em;
        }

        h4 {
            font-size: 16px;
            font-weight: 600;
            margin: 24px 0 12px;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 16px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        /* ========================================
           GLASSMORPHISM TABLES
           ======================================== */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
            border-radius: 16px;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            padding: 2px;
        }

        .table-wrapper::-webkit-scrollbar { height: 6px; }
        .table-wrapper::-webkit-scrollbar-track { background: transparent; }
        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 3px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: rgba(109, 30, 212, 0.1);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:last-child td { border-bottom: none; }

        tr {
            transition: background var(--transition-fast);
        }

        tr:hover td {
            background: rgba(109, 30, 212, 0.05);
        }

        /* ========================================
           CODE BLOCKS - Premium Style
           ======================================== */
        pre {
            background: linear-gradient(145deg, rgba(10, 10, 15, 0.9), rgba(18, 18, 26, 0.95));
            padding: 24px;
            border-radius: 16px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            position: relative;
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        pre::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 16px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #EF4444;
            box-shadow:
                20px 0 0 #F59E0B,
                40px 0 0 #10B981;
        }

        pre code {
            display: block;
            padding-top: 16px;
        }

        code {
            font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
            font-size: 13px;
            color: var(--accent-success);
        }

        pre code { color: var(--text-secondary); }

        p code, li code, td code {
            background: rgba(109, 30, 212, 0.15);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--zelle-purple-light);
            border: 1px solid rgba(109, 30, 212, 0.2);
        }

        /* ========================================
           BADGES - Gradient Style
           ======================================== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 3px;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .badge-quarkus { background: linear-gradient(135deg, #4695eb, #2563eb); color: #fff; }
        .badge-pubsub { background: linear-gradient(135deg, #4285f4, #1d4ed8); color: #fff; }
        .badge-postgres { background: linear-gradient(135deg, #336791, #1e3a5f); color: #fff; }
        .badge-java { background: linear-gradient(135deg, #f89820, #ea580c); color: #000; }
        .badge-openai { background: linear-gradient(135deg, #412991, #6D1ED4); color: #fff; }
        .badge-gemini { background: linear-gradient(135deg, #8e44ad, #a855f7); color: #fff; }
        .badge-gmail { background: linear-gradient(135deg, #ea4335, #dc2626); color: #fff; }
        .badge-outlook { background: linear-gradient(135deg, #0078d4, #0369a1); color: #fff; }
        .badge-k8s { background: linear-gradient(135deg, #326ce5, #2563eb); color: #fff; }
        .badge-flutter { background: linear-gradient(135deg, #02569B, #0284c7); color: #fff; }
        .badge-firebase { background: linear-gradient(135deg, #FFCA28, #f59e0b); color: #000; }
        .badge-terraform { background: linear-gradient(135deg, #7b42bc, #9333ea); color: #fff; }
        .badge-gcp { background: linear-gradient(135deg, #4285f4, #3b82f6); color: #fff; }

        /* ========================================
           COLLAPSIBLE SECTIONS - Glass Effect
           ======================================== */
        .collapsible {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin: 20px 0;
            overflow: hidden;
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
        }

        .collapsible:hover {
            border-color: var(--border-hover);
            box-shadow: 0 8px 32px rgba(109, 30, 212, 0.1);
        }

        .collapsible-header {
            padding: 18px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background var(--transition-fast);
        }

        .collapsible-header:hover {
            background: rgba(109, 30, 212, 0.08);
        }

        .collapsible-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .collapsible-content {
            padding: 0 24px 24px;
            display: none;
        }

        .collapsible.open .collapsible-content { display: block; }

        .collapsible-toggle {
            font-size: 14px;
            color: var(--zelle-purple-light);
            transition: transform var(--transition-normal);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(109, 30, 212, 0.1);
            border-radius: 6px;
        }

        .collapsible.open .collapsible-toggle {
            transform: rotate(180deg);
            background: var(--zelle-purple);
            color: white;
        }

        ul, ol {
            margin: 12px 0 16px 28px;
            color: var(--text-secondary);
        }

        li {
            margin-bottom: 8px;
            line-height: 1.7;
        }

        /* ========================================
           DIAGRAMS - Neon Glow
           ======================================== */
        .diagram {
            background: linear-gradient(145deg, rgba(10, 10, 15, 0.95), rgba(18, 18, 26, 0.98));
            padding: 28px;
            border-radius: 16px;
            margin: 24px 0;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            overflow-x: auto;
            white-space: pre;
            border: 1px solid var(--border-color);
            line-height: 1.5;
            color: var(--zelle-purple-light);
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.3),
                inset 0 0 60px rgba(109, 30, 212, 0.03);
        }

        /* ========================================
           PROJECT CARDS - Premium Glass
           ======================================== */
        .project-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            margin: 24px 0;
            overflow: hidden;
            transition: all var(--transition-normal);
            position: relative;
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .project-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-4px);
            box-shadow:
                0 20px 40px rgba(109, 30, 212, 0.15),
                0 0 0 1px rgba(139, 92, 246, 0.1);
        }

        .project-card:hover::before {
            opacity: 1;
        }

        .project-card-header {
            background: linear-gradient(135deg, rgba(109, 30, 212, 0.1), rgba(246, 133, 27, 0.05));
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 12px;
        }

        .project-card-header h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            color: var(--text-primary);
        }

        .project-card-body { padding: 24px; }

        /* ========================================
           ALERTS - Glowing Borders
           ======================================== */
        .alert {
            padding: 18px 22px;
            border-radius: 14px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            font-size: 14px;
            line-height: 1.7;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.08);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--accent-warning);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.05);
        }

        .alert-info {
            background: rgba(109, 30, 212, 0.08);
            border: 1px solid rgba(109, 30, 212, 0.3);
            color: var(--zelle-purple-light);
            box-shadow: 0 0 20px rgba(109, 30, 212, 0.05);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--accent-success);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.05);
        }

        /* ========================================
           FLOW STEPS
           ======================================== */
        .flow-step {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 18px;
            margin: 12px 0;
            transition: all var(--transition-fast);
        }

        .flow-step:hover {
            border-color: var(--border-hover);
            background: rgba(109, 30, 212, 0.05);
        }

        .flow-step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            margin-right: 14px;
            box-shadow: 0 4px 12px rgba(109, 30, 212, 0.3);
        }

        .flow-arrow {
            text-align: center;
            color: var(--zelle-purple-light);
            font-size: 28px;
            margin: 8px 0;
        }

        /* ========================================
           TOC
           ======================================== */
        .toc {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 16px;
            margin: 24px 0;
            border: 1px solid var(--border-color);
        }

        .toc-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .toc-list { list-style: none; margin: 0; padding: 0; }
        .toc-list li { margin: 10px 0; }
        .toc-list a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: all var(--transition-fast);
            display: inline-block;
        }
        .toc-list a:hover {
            color: var(--zelle-purple-light);
            transform: translateX(4px);
        }

        .highlight { color: var(--zelle-purple-light); }
        .highlight-secondary { color: var(--metamask-orange); }

        .pubsub-topic {
            background: var(--gradient-primary);
            color: #fff;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        /* ========================================
           RESPONSIVE DESIGN - Premium Mobile Experience
           ======================================== */

        /* Mobile Menu Toggle Button - Gradient Style */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 12px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            font-size: 22px;
            box-shadow:
                0 4px 20px rgba(109, 30, 212, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            transition: all var(--transition-normal);
        }

        .mobile-menu-toggle:hover {
            transform: scale(1.08);
            box-shadow:
                0 8px 30px rgba(109, 30, 212, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }

        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }

        /* Sidebar Overlay for Mobile - Premium Blur */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.8);
            z-index: 999;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .sidebar-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Back to Top Button - Floating Gradient */
        .back-to-top {
            display: none;
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 998;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 14px;
            width: 52px;
            height: 52px;
            cursor: pointer;
            font-size: 22px;
            box-shadow:
                0 8px 24px rgba(109, 30, 212, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            transition: all var(--transition-normal);
        }

        .back-to-top.visible {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .back-to-top:hover {
            transform: translateY(-4px);
            box-shadow:
                0 12px 32px rgba(109, 30, 212, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }

        /* Large Tablets and Small Desktops */
        @media (max-width: 1200px) {
            .sidebar { width: 280px; }
            .main-content {
                margin-left: 280px;
                padding: 40px 36px;
            }
            .page-header h1 { font-size: 36px; }
            .section-title { font-size: 24px; }
        }

        /* Tablets */
        @media (max-width: 1024px) {
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 1000;
                width: 300px;
                box-shadow: none;
            }

            .sidebar.open {
                transform: translateX(0);
                box-shadow: 20px 0 60px rgba(109, 30, 212, 0.2);
            }

            .main-content {
                margin-left: 0;
                padding: 80px 32px 48px;
            }

            table { min-width: 600px; }

            .diagram {
                font-size: 11px;
                padding: 20px;
            }

            .project-card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            /* Hide animated gradient on tablets for performance */
            .gradient-bg::before,
            .gradient-bg::after {
                animation: none;
            }
        }

        /* Mobile Phones */
        @media (max-width: 768px) {
            body { font-size: 14px; }

            .main-content {
                padding: 76px 20px 40px;
            }

            .page-header {
                margin-bottom: 32px;
                padding-bottom: 24px;
            }

            .page-header h1 {
                font-size: 28px;
                line-height: 1.25;
            }

            .page-header .meta { font-size: 13px; }

            .page-header .badge {
                font-size: 9px;
                padding: 4px 8px;
            }

            .section { margin-bottom: 40px; }

            .section-title {
                font-size: 22px;
                margin-bottom: 18px;
            }

            h3 { font-size: 16px; margin: 24px 0 14px; }
            h4 { font-size: 15px; margin: 18px 0 10px; }

            /* Code blocks */
            pre {
                padding: 16px;
                padding-top: 32px;
                font-size: 11px;
                border-radius: 12px;
                margin: 16px -12px;
            }

            pre::before {
                top: 10px;
                left: 12px;
                width: 10px;
                height: 10px;
                box-shadow: 16px 0 0 #F59E0B, 32px 0 0 #10B981;
            }

            code { font-size: 11px; }

            p code, li code, td code {
                font-size: 10px;
                padding: 2px 6px;
            }

            /* Tables */
            table { font-size: 12px; min-width: 520px; }
            th, td { padding: 10px 12px; }

            .table-wrapper {
                margin: 16px -12px;
                border-radius: 12px;
            }

            /* Diagrams */
            .diagram {
                font-size: 10px;
                padding: 16px;
                line-height: 1.4;
                margin: 18px -12px;
                border-radius: 12px;
            }

            /* Cards */
            .project-card {
                margin: 18px 0;
                border-radius: 16px;
            }

            .project-card-header { padding: 16px 18px; }
            .project-card-header h2 { font-size: 16px; }
            .project-card-body { padding: 18px; }

            /* Collapsibles */
            .collapsible {
                margin: 16px 0;
                border-radius: 14px;
            }

            .collapsible-header { padding: 14px 18px; }
            .collapsible-header h3 { font-size: 14px; }
            .collapsible-content { padding: 0 18px 18px; }

            /* Alerts */
            .alert {
                padding: 14px 16px;
                font-size: 13px;
                margin: 16px 0;
                border-radius: 12px;
            }

            /* Flow steps */
            .flow-step {
                padding: 14px;
                border-radius: 12px;
            }

            .flow-step-number {
                width: 28px;
                height: 28px;
                font-size: 13px;
                margin-right: 12px;
                border-radius: 8px;
            }

            /* TOC */
            .toc {
                padding: 18px;
                border-radius: 14px;
            }

            .toc-title { font-size: 15px; }
            .toc-list li { margin: 8px 0; }

            /* Badges */
            .badge {
                font-size: 9px;
                padding: 4px 8px;
                border-radius: 16px;
            }

            .pubsub-topic {
                font-size: 10px;
                padding: 4px 8px;
            }

            /* Lists */
            ul, ol { margin-left: 22px; }
            li { margin-bottom: 6px; font-size: 14px; }

            /* Sidebar mobile */
            .sidebar {
                width: 85vw;
                max-width: 320px;
            }

            .sidebar-header {
                padding: 20px;
            }

            .sidebar-header h1 { font-size: 20px; }

            .nav-section { padding: 10px 16px; }

            .nav-link {
                padding: 12px 14px;
                font-size: 14px;
                border-radius: 10px;
            }
        }

        /* Small Mobile Phones */
        @media (max-width: 480px) {
            .main-content {
                padding: 72px 16px 32px;
            }

            .page-header h1 { font-size: 24px; }
            .section-title { font-size: 20px; }
            h3 { font-size: 15px; }

            pre {
                font-size: 10px;
                padding: 14px;
                padding-top: 28px;
                margin: 14px -16px;
                border-radius: 0;
            }

            .diagram {
                font-size: 9px;
                padding: 14px;
                margin: 16px -16px;
                border-radius: 0;
            }

            table {
                font-size: 11px;
                min-width: 460px;
            }

            th, td { padding: 8px 10px; }

            .table-wrapper {
                margin: 14px -16px;
                border-radius: 0;
            }

            .project-card-header h2 { font-size: 15px; }
            .project-card-body { padding: 16px; }

            .mobile-menu-toggle {
                top: 14px;
                left: 14px;
                width: 44px;
                height: 44px;
                border-radius: 10px;
            }

            .back-to-top {
                bottom: 20px;
                right: 20px;
                width: 48px;
                height: 48px;
                border-radius: 12px;
            }
        }

        /* Landscape orientation */
        @media (max-width: 900px) and (orientation: landscape) {
            .main-content {
                padding-top: 70px;
            }

            .sidebar {
                width: 50vw;
                max-width: 300px;
            }
        }

        /* High DPI / Retina */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .badge, .pubsub-topic {
                font-weight: 600;
            }
        }

        /* Print styles */
        @media print {
            .sidebar,
            .mobile-menu-toggle,
            .back-to-top,
            .sidebar-overlay,
            .gradient-bg,
            .noise-overlay {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 24px !important;
            }

            .collapsible-content { display: block !important; }

            pre, .diagram {
                white-space: pre-wrap;
                page-break-inside: avoid;
                background: #f5f5f5 !important;
                color: #333 !important;
            }

            body {
                background: white !important;
                color: #333 !important;
            }
        }

        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus states for accessibility */
        .nav-link:focus,
        .mobile-menu-toggle:focus,
        .back-to-top:focus,
        .collapsible-header:focus {
            outline: 2px solid var(--zelle-purple-light);
            outline-offset: 3px;
        }

        /* Touch targets - ensure minimum 44px */
        @media (pointer: coarse) {
            .nav-link {
                min-height: 48px;
            }

            .collapsible-header {
                min-height: 52px;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Gradient Background (Stripe-inspired) -->
    <div class="gradient-bg" aria-hidden="true"></div>
    <div class="noise-overlay" aria-hidden="true"></div>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" aria-label="Abrir menu de navegacion" aria-expanded="false">
        <span class="menu-icon">&#9776;</span>
    </button>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" aria-hidden="true"></div>

    <!-- Back to Top Button -->
    <button class="back-to-top" aria-label="Volver arriba">&#8679;</button>

    <div class="container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>PilasFi Platform</h1>
                <div class="version">Documentacion Tecnica v3.0</div>
                <div class="version">Actualizado: 2026-01-23</div>
                <div class="version">Arquitectura: GCP Cloud Run</div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">General</div>
                <a href="#overview" class="nav-link">Vista General</a>
                <a href="#architecture" class="nav-link">Arquitectura Hexagonal</a>
                <a href="#data-flow" class="nav-link">Flujo de Datos</a>
                <a href="#pubsub-topics" class="nav-link">Pub/Sub Topics</a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Microservicios</div>
                <a href="#pilasfi-quarkus" class="nav-link">pilasfi-quarkus (API)</a>
                <a href="#pilasfi-parser" class="nav-link">pilasfi-parser-service</a>
                <a href="#pilasfi-email-sync" class="nav-link">pilasfi-email-sync</a>
                <a href="#pilasfi-sync-scheduler" class="nav-link">pilasfi-sync-scheduler</a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Frontend</div>
                <a href="#app-pilas-fe" class="nav-link">app-pilas-fe (Flutter)</a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Infraestructura</div>
                <a href="#infra-gcp" class="nav-link">pilasfi-infra-gcp</a>
                <a href="#infra-apps" class="nav-link">pilasfi-infra-apps (K8s)</a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Flujos Detallados</div>
                <a href="#distributed-scheduler" class="nav-link">Scheduler Distribuido</a>
                <a href="#email-sync-flow" class="nav-link">Sincronizacion Email</a>
                <a href="#parser-flow" class="nav-link">Pipeline de Parsing</a>
                <a href="#oauth-flow" class="nav-link">Flujo OAuth</a>
                <a href="#token-refresh" class="nav-link">Token Refresh</a>
            </div>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1>PilasFi - Documentacion Tecnica</h1>
                <p class="meta">
                    Plataforma de gestion financiera personal con sincronizacion automatica de emails bancarios
                    <br>
                    <span class="badge badge-gcp">GCP</span>
                    <span class="badge badge-pubsub">Pub/Sub</span>
                    <span class="badge badge-quarkus">Quarkus</span>
                    <span class="badge badge-flutter">Flutter</span>
                    <span class="badge badge-openai">OpenAI</span>
                    <span class="badge badge-gemini">Gemini</span>
                </p>
            </div>

            <!-- OVERVIEW SECTION -->
            <section id="overview" class="section">
                <h2 class="section-title">Vista General del Sistema</h2>

                <div class="alert alert-info">
                    <strong>Arquitectura Nueva:</strong> El sistema ahora usa Google Cloud Pub/Sub para mensajeria asincrona
                    y soporta multiples proveedores de IA (OpenAI GPT-4o-mini y Google Gemini).
                </div>

                <h3>Repositorios del Proyecto</h3>
                <table>
                    <tr>
                        <th>Repositorio</th>
                        <th>Branch Activo</th>
                        <th>Descripcion</th>
                        <th>Tecnologias</th>
                    </tr>
                    <tr>
                        <td><code>pilasfi-quarkus</code></td>
                        <td><code>feat/new-backend-architecture</code></td>
                        <td>API principal, OAuth, gestion de transacciones</td>
                        <td>Quarkus, Java 21, PostgreSQL</td>
                    </tr>
                    <tr>
                        <td><code>pilasfi-parser-service</code></td>
                        <td><code>feature/newarch</code></td>
                        <td>Parsing de emails con Regex + IA</td>
                        <td>Quarkus, OpenAI, Gemini</td>
                    </tr>
                    <tr>
                        <td><code>pilasfi-email-sync</code></td>
                        <td><code>feature/fixandres</code></td>
                        <td>Sincronizacion Gmail/Outlook</td>
                        <td>Quarkus, OAuth2, Pub/Sub</td>
                    </tr>
                    <tr>
                        <td><code>app-pilas-fe</code></td>
                        <td><code>main</code></td>
                        <td>Aplicacion movil</td>
                        <td>Flutter, Riverpod, Firebase</td>
                    </tr>
                    <tr>
                        <td><code>pilasfi-infra-gcp</code></td>
                        <td><code>feature/init</code></td>
                        <td>Infraestructura GCP con Terraform</td>
                        <td>Terraform, Cloud Run, Cloud SQL</td>
                    </tr>
                    <tr>
                        <td><code>pilasfi-infra-apps</code></td>
                        <td><code>feature/new</code></td>
                        <td>Manifiestos Kubernetes (alternativo)</td>
                        <td>Kustomize, ArgoCD, Helm</td>
                    </tr>
                </table>

                <h3>Diagrama de Arquitectura General</h3>
                <div class="diagram">
+------------------+     +-------------------+     +----------------------+
|   app-pilas-fe   |     |  pilasfi-quarkus  |     | pilasfi-email-sync   |
|    (Flutter)     |---->|    (API Core)     |<----|  (Gmail/Outlook)     |
+------------------+     +-------------------+     +----------------------+
        |                        |                          |
        | REST API               | Pub/Sub                  | Pub/Sub
        v                        v                          v
+------------------+     +-------------------+     +----------------------+
|  Firebase Auth   |     |   Cloud SQL       |     | pilasfi-parser-svc   |
|  (Google SSO)    |     |  (PostgreSQL)     |     |  (Regex + AI)        |
+------------------+     +-------------------+     +----------------------+

                    Google Cloud Pub/Sub Topics:
    +------------------------------------------------------------------+
    |  user-email-config  |  email-raw  |  email-transaction  |        |
    |  token-refreshed    |  sync-batch |  parsing-result     |        |
    +------------------------------------------------------------------+
                </div>
            </section>

            <!-- ARCHITECTURE SECTION -->
            <section id="architecture" class="section">
                <h2 class="section-title">Arquitectura Hexagonal</h2>

                <p>Todos los microservicios siguen el patron de Arquitectura Hexagonal (Ports & Adapters),
                separando claramente el dominio de la infraestructura.</p>

                <h3>Estructura de Capas</h3>
                <div class="diagram">
+------------------------------------------------------------------+
|                        ADAPTERS (Infrastructure)                  |
|  +--------------------+  +--------------------+  +--------------+ |
|  | REST Controllers   |  | Pub/Sub Consumers  |  | Pub/Sub      | |
|  | (Inbound)          |  | (Inbound)          |  | Publishers   | |
|  +--------------------+  +--------------------+  +--------------+ |
+------------------------------------------------------------------+
                              |
                              v
+------------------------------------------------------------------+
|                          PORTS (Interfaces)                       |
|  +--------------------+  +--------------------+  +--------------+ |
|  | Use Cases          |  | Repository Ports   |  | Event Ports  | |
|  | (Application)      |  | (Domain)           |  | (Domain)     | |
|  +--------------------+  +--------------------+  +--------------+ |
+------------------------------------------------------------------+
                              |
                              v
+------------------------------------------------------------------+
|                           DOMAIN (Core)                           |
|  +--------------------+  +--------------------+  +--------------+ |
|  | Entities           |  | Value Objects      |  | Domain       | |
|  | Aggregates         |  | Domain Services    |  | Events       | |
|  +--------------------+  +--------------------+  +--------------+ |
+------------------------------------------------------------------+
                </div>

                <h3>Paquetes por Servicio</h3>
                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>pilasfi-quarkus - Estructura de Paquetes</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code>com.pilasfi/
├── domain/
│   ├── model/
│   │   ├── Transaction.java
│   │   ├── User.java
│   │   ├── EmailConfig.java
│   │   ├── EmailAccount.java
│   │   └── UserProfile.java
│   ├── event/
│   │   ├── EmailConfigUpdatedEvent.java
│   │   ├── TransactionParsedEvent.java
│   │   └── TokenRefreshedEvent.java
│   ├── port/
│   │   ├── in/
│   │   │   ├── TransactionUseCase.java
│   │   │   ├── EmailConfigUseCase.java
│   │   │   └── UserProfileUseCase.java
│   │   └── out/
│   │       ├── TransactionRepository.java
│   │       ├── EmailConfigRepository.java
│   │       └── EventPublisher.java
│   └── service/
│       ├── TransactionService.java
│       ├── EmailConfigService.java
│       └── UserProfileService.java
├── application/
│   ├── TransactionApplicationService.java
│   └── EmailConfigApplicationService.java
└── adapter/
    ├── in/
    │   ├── rest/
    │   │   ├── TransactionResource.java
    │   │   ├── EmailConfigResource.java
    │   │   ├── UserProfileResource.java
    │   │   └── AuthResource.java
    │   └── pubsub/
    │       ├── TransactionParsedEventConsumer.java
    │       └── TokenRefreshedEventConsumer.java
    └── out/
        ├── persistence/
        │   ├── TransactionRepositoryImpl.java
        │   ├── EmailConfigRepositoryImpl.java
        │   └── entity/ (JPA Entities)
        └── messaging/
            └── PubSubEventPublisher.java</code></pre>
                    </div>
                </div>
            </section>

            <!-- PUBSUB TOPICS SECTION -->
            <section id="pubsub-topics" class="section">
                <h2 class="section-title">Google Cloud Pub/Sub Topics</h2>

                <div class="alert alert-warning">
                    <strong>Importante:</strong> La arquitectura usa Pub/Sub en lugar de Kafka para el despliegue en GCP.
                    Los topics de Kubernetes (Strimzi Kafka) son una alternativa para despliegues on-premise.
                </div>

                <h3>Topics y Flujo de Mensajes</h3>
                <table>
                    <tr>
                        <th>Topic</th>
                        <th>Publisher</th>
                        <th>Subscriber</th>
                        <th>Payload</th>
                    </tr>
                    <tr>
                        <td><span class="pubsub-topic">user-email-config</span></td>
                        <td>pilasfi-quarkus</td>
                        <td>pilasfi-email-sync</td>
                        <td>EmailConfigUpdatedEvent (userId, emailProvider, tokens)</td>
                    </tr>
                    <tr>
                        <td><span class="pubsub-topic">email-raw</span></td>
                        <td>pilasfi-email-sync</td>
                        <td>pilasfi-parser-service</td>
                        <td>EmailRawEvent (messageId, subject, body, sender, userId)</td>
                    </tr>
                    <tr>
                        <td><span class="pubsub-topic">email-transaction</span></td>
                        <td>pilasfi-parser-service</td>
                        <td>pilasfi-quarkus</td>
                        <td>TransactionParsedEvent (amount, merchant, category, date)</td>
                    </tr>
                    <tr>
                        <td><span class="pubsub-topic">token-refreshed</span></td>
                        <td>pilasfi-email-sync</td>
                        <td>pilasfi-quarkus</td>
                        <td>TokenRefreshedEvent (userId, provider, newTokens)</td>
                    </tr>
                    <tr>
                        <td><span class="pubsub-topic">sync-email-request</span></td>
                        <td>pilasfi-sync-scheduler</td>
                        <td>pilasfi-email-sync</td>
                        <td>SyncRequestEvent (userId, emailConfigId, syncType, partitionKey)</td>
                    </tr>
                </table>

                <h3>Diagrama de Flujo Pub/Sub</h3>
                <div class="diagram">
                        FLUJO INICIAL (Usuario configura email)
                        ========================================
Usuario configura email en App
            |
            v
+-------------------+   user-email-config   +----------------------+
| pilasfi-quarkus   |---------------------->| pilasfi-email-sync   |
| (API)             |                       | (Sync Service)       |
+-------------------+                       +----------------------+
                                                      |
                        FLUJO PERIODICO (Scheduler Distribuido)
                        ========================================
                                                      |
+-------------------+                                 |
| Cloud Scheduler   | (cada 5 min, HTTP trigger)      |
| (GCP Managed)     |                                 |
+-------------------+                                 |
            |                                         |
            v                                         |
+------------------------+  sync-email-request        |
| pilasfi-sync-scheduler |----------------------+     |
| (Orchestrator)         |                      |     |
| - Atomic marking       |                      v     v
| - Outbox pattern       |              +----------------------+
+------------------------+              | pilasfi-email-sync   |
                                        | (Sync Service)       |
                                        +----------------------+
                                                  |
                                                  | Lee emails de
                                                  | Gmail/Outlook
                                                  v
+-------------------+                   +----------------------+
| pilasfi-quarkus   |    email-raw      |  Emails encontrados  |
| (API)             |<------------------|  (filtrados)         |
+-------------------+                   +----------------------+
            ^                                     |
            |                                     v
            |                           +----------------------+
            |    email-transaction      | pilasfi-parser-svc   |
            |<--------------------------| (Regex + AI Parse)   |
            |                           +----------------------+
            v
+-------------------+
| Transaccion       |
| guardada en DB    |
+-------------------+
                </div>
            </section>

            <!-- PILASFI-QUARKUS SECTION -->
            <section id="pilasfi-quarkus" class="section">
                <h2 class="section-title">pilasfi-quarkus (API Principal)</h2>

                <div class="project-card">
                    <div class="project-card-header">
                        <h2>Microservicio Core</h2>
                        <div>
                            <span class="badge badge-quarkus">Quarkus 3.x</span>
                            <span class="badge badge-java">Java 21</span>
                            <span class="badge badge-postgres">PostgreSQL</span>
                            <span class="badge badge-pubsub">Pub/Sub</span>
                        </div>
                    </div>
                    <div class="project-card-body">
                        <p>API REST principal que maneja autenticacion, usuarios, transacciones y configuracion de emails.
                        Actua como orquestador del sistema publicando eventos y consumiendo resultados.</p>
                    </div>
                </div>

                <h3>Endpoints REST Principales</h3>
                <table>
                    <tr>
                        <th>Metodo</th>
                        <th>Endpoint</th>
                        <th>Descripcion</th>
                        <th>Archivo</th>
                    </tr>
                    <tr>
                        <td><code>POST</code></td>
                        <td><code>/api/auth/google</code></td>
                        <td>Login con Google OAuth</td>
                        <td>AuthResource.java</td>
                    </tr>
                    <tr>
                        <td><code>GET</code></td>
                        <td><code>/api/transactions</code></td>
                        <td>Listar transacciones del usuario</td>
                        <td>TransactionResource.java</td>
                    </tr>
                    <tr>
                        <td><code>POST</code></td>
                        <td><code>/api/transactions</code></td>
                        <td>Crear transaccion manual</td>
                        <td>TransactionResource.java</td>
                    </tr>
                    <tr>
                        <td><code>PUT</code></td>
                        <td><code>/api/transactions/{id}</code></td>
                        <td>Actualizar transaccion</td>
                        <td>TransactionResource.java</td>
                    </tr>
                    <tr>
                        <td><code>DELETE</code></td>
                        <td><code>/api/transactions/{id}</code></td>
                        <td>Eliminar transaccion</td>
                        <td>TransactionResource.java</td>
                    </tr>
                    <tr>
                        <td><code>POST</code></td>
                        <td><code>/api/email-config</code></td>
                        <td>Configurar sincronizacion de email</td>
                        <td>EmailConfigResource.java</td>
                    </tr>
                    <tr>
                        <td><code>GET</code></td>
                        <td><code>/api/email-config</code></td>
                        <td>Obtener configuracion actual</td>
                        <td>EmailConfigResource.java</td>
                    </tr>
                    <tr>
                        <td><code>GET</code></td>
                        <td><code>/api/user/profile</code></td>
                        <td>Obtener perfil de usuario</td>
                        <td>UserProfileResource.java</td>
                    </tr>
                    <tr>
                        <td><code>PUT</code></td>
                        <td><code>/api/user/profile</code></td>
                        <td>Actualizar perfil (display name)</td>
                        <td>UserProfileResource.java</td>
                    </tr>
                </table>

                <h3>Consumidores Pub/Sub</h3>
                <div class="collapsible open">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>TransactionParsedEventConsumer</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <p>Consume transacciones parseadas del topic <code>email-transaction</code> y las persiste en la base de datos.</p>
<pre><code>@ApplicationScoped
public class TransactionParsedEventConsumer {

    @Inject TransactionRepository transactionRepository;
    @Inject UserRepository userRepository;

    @Incoming("email-transaction")
    public CompletionStage&lt;Void&gt; consume(TransactionParsedEvent event) {
        // 1. Buscar usuario por ID
        User user = userRepository.findById(event.getUserId());

        // 2. Crear entidad Transaction
        Transaction transaction = Transaction.builder()
            .user(user)
            .amount(event.getAmount())
            .merchant(event.getMerchant())
            .category(event.getCategory())
            .transactionDate(event.getTransactionDate())
            .emailMessageId(event.getEmailMessageId())
            .type(event.getTransactionType())
            .build();

        // 3. Verificar duplicados por emailMessageId
        if (!transactionRepository.existsByEmailMessageId(event.getEmailMessageId())) {
            transactionRepository.persist(transaction);
        }

        return CompletableFuture.completedFuture(null);
    }
}</code></pre>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>TokenRefreshedEventConsumer</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <p>Consume eventos de tokens refrescados y actualiza los tokens OAuth en la base de datos.</p>
<pre><code>@ApplicationScoped
public class TokenRefreshedEventConsumer {

    @Inject EmailConfigRepository emailConfigRepository;

    @Incoming("token-refreshed")
    public CompletionStage&lt;Void&gt; consume(TokenRefreshedEvent event) {
        // 1. Buscar configuracion de email del usuario
        EmailConfig config = emailConfigRepository
            .findByUserIdAndProvider(event.getUserId(), event.getProvider());

        // 2. Actualizar tokens
        config.setAccessToken(event.getAccessToken());
        config.setRefreshToken(event.getRefreshToken());
        config.setTokenExpiresAt(event.getExpiresAt());

        // 3. Persistir cambios
        emailConfigRepository.persist(config);

        return CompletableFuture.completedFuture(null);
    }
}</code></pre>
                    </div>
                </div>

                <h3>Modelo de Dominio</h3>
                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Entidades Principales</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code>// Transaction.java
@Entity
public class Transaction {
    @Id @GeneratedValue
    private UUID id;

    @ManyToOne
    private User user;

    private BigDecimal amount;
    private String merchant;
    private String category;
    private LocalDateTime transactionDate;
    private String emailMessageId;  // Para evitar duplicados

    @Enumerated(EnumType.STRING)
    private TransactionType type;  // INCOME, EXPENSE

    private String description;
    private String bankName;
}

// EmailConfig.java
@Entity
public class EmailConfig {
    @Id @GeneratedValue
    private UUID id;

    @ManyToOne
    private User user;

    @Enumerated(EnumType.STRING)
    private EmailProvider provider;  // GMAIL, OUTLOOK

    private String emailAddress;
    private String accessToken;
    private String refreshToken;
    private LocalDateTime tokenExpiresAt;
    private LocalDateTime lastSyncAt;
    private boolean active;
}

// UserProfile.java
@Entity
public class UserProfile {
    @Id @GeneratedValue
    private UUID id;

    @OneToOne
    private User user;

    private String displayName;  // Usado para filtrar transferencias personales
    private String preferredCurrency;
    private String timezone;
}</code></pre>
                    </div>
                </div>
            </section>

            <!-- PILASFI-PARSER-SERVICE SECTION -->
            <section id="pilasfi-parser" class="section">
                <h2 class="section-title">pilasfi-parser-service</h2>

                <div class="project-card">
                    <div class="project-card-header">
                        <h2>Servicio de Parsing</h2>
                        <div>
                            <span class="badge badge-quarkus">Quarkus 3.x</span>
                            <span class="badge badge-openai">OpenAI</span>
                            <span class="badge badge-gemini">Gemini</span>
                            <span class="badge badge-postgres">PostgreSQL</span>
                        </div>
                    </div>
                    <div class="project-card-body">
                        <p>Servicio que parsea emails bancarios usando un pipeline de 3 niveles:
                        Regex desde base de datos, IA como fallback, y descarte para emails no transaccionales.</p>
                    </div>
                </div>

                <h3>Pipeline de Parsing (3 Niveles)</h3>
                <div class="diagram">
Email Entrante (email-raw topic)
            |
            v
+---------------------------+
|  1. REGEX DB PARSERS      |
|  - Busca patron por banco |
|  - Extrae con regex       |
+---------------------------+
            |
            | No match?
            v
+---------------------------+
|  2. DISCARD PARSERS       |
|  - Detecta emails no-tx   |
|  - Marketing, alertas     |
+---------------------------+
            |
            | No es descartable?
            v
+---------------------------+
|  3. AI FALLBACK           |
|  - OpenAI GPT-4o-mini     |
|  - Google Gemini          |
|  - Extraccion inteligente |
+---------------------------+
            |
            v
+---------------------------+
|  4. CATEGORY PARSERS      |
|  - Categoriza merchant    |
|  - Mapeo de categorias    |
+---------------------------+
            |
            v
+---------------------------+
|  5. DISPLAY NAME FILTER   |
|  - Filtra transferencias  |
|  - a uno mismo            |
+---------------------------+
            |
            v
Publica a email-transaction topic
                </div>

                <h3>Tipos de Parsers</h3>
                <table>
                    <tr>
                        <th>Tipo</th>
                        <th>Descripcion</th>
                        <th>Tabla DB</th>
                        <th>Ejemplo</th>
                    </tr>
                    <tr>
                        <td><strong>Transaction Parser</strong></td>
                        <td>Extrae monto, comercio, fecha de emails de compra/venta</td>
                        <td><code>transaction_parsers</code></td>
                        <td>Regex para BCP, BBVA, Interbank</td>
                    </tr>
                    <tr>
                        <td><strong>Discard Parser</strong></td>
                        <td>Identifica emails que NO son transacciones</td>
                        <td><code>discard_parsers</code></td>
                        <td>Marketing, alertas de seguridad, OTPs</td>
                    </tr>
                    <tr>
                        <td><strong>Category Parser</strong></td>
                        <td>Asigna categoria al comercio detectado</td>
                        <td><code>category_parsers</code></td>
                        <td>"UBER" -> Transporte, "WONG" -> Supermercado</td>
                    </tr>
                    <tr>
                        <td><strong>Blacklist</strong></td>
                        <td>Remitentes a ignorar completamente</td>
                        <td><code>sender_blacklist</code></td>
                        <td>newsletters@bank.com</td>
                    </tr>
                </table>

                <h3>Modelo de Datos del Parser</h3>
                <div class="collapsible open">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Entidades del Parser</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code>// TransactionParser.java - Parser de transacciones
@Entity
@Table(name = "transaction_parsers")
public class TransactionParser {
    @Id @GeneratedValue
    private UUID id;

    private String bankName;           // "BCP", "BBVA", "Interbank"
    private String senderPattern;      // Regex para validar remitente
    private String subjectPattern;     // Regex para validar asunto
    private String amountRegex;        // Regex para extraer monto
    private String merchantRegex;      // Regex para extraer comercio
    private String dateRegex;          // Regex para extraer fecha
    private String dateFormat;         // "dd/MM/yyyy", "yyyy-MM-dd"
    private boolean active;
    private int priority;              // Orden de evaluacion
}

// DiscardParser.java - Parser de descarte
@Entity
@Table(name = "discard_parsers")
public class DiscardParser {
    @Id @GeneratedValue
    private UUID id;

    private String name;               // "BCP Marketing", "OTP Alert"
    private String senderPattern;      // Regex del remitente
    private String subjectPattern;     // Regex del asunto (opcional)
    private String bodyPattern;        // Regex del cuerpo (opcional)
    private String reason;             // "Marketing email", "Security alert"
    private boolean active;
}

// CategoryParser.java - Parser de categorias
@Entity
@Table(name = "category_parsers")
public class CategoryParser {
    @Id @GeneratedValue
    private UUID id;

    private String merchantPattern;    // Regex: "UBER.*", "WONG|METRO"
    private String category;           // "Transporte", "Supermercado"
    private int priority;
    private boolean active;
}

// SenderBlacklist.java - Lista negra
@Entity
@Table(name = "sender_blacklist")
public class SenderBlacklist {
    @Id @GeneratedValue
    private UUID id;

    private String senderEmail;        // Email completo o patron
    private String reason;
    private boolean active;
}</code></pre>
                    </div>
                </div>

                <h3>Proveedores de IA</h3>
                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Selector de Proveedor IA</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <p>El sistema soporta multiples proveedores de IA con seleccion dinamica:</p>
<pre><code>// AIProviderSelector.java
@ApplicationScoped
public class AIProviderSelector {

    @ConfigProperty(name = "ai.provider", defaultValue = "openai")
    String configuredProvider;

    @Inject OpenAIService openAIService;
    @Inject GeminiService geminiService;

    public AIProvider getProvider() {
        return switch (configuredProvider.toLowerCase()) {
            case "gemini" -> geminiService;
            case "openai" -> openAIService;
            default -> openAIService;
        };
    }
}

// OpenAIService.java
@ApplicationScoped
public class OpenAIService implements AIProvider {

    @ConfigProperty(name = "openai.api.key")
    String apiKey;

    @ConfigProperty(name = "openai.model", defaultValue = "gpt-4o-mini")
    String model;

    @Override
    public TransactionData parseEmail(String subject, String body) {
        // Llamada a OpenAI API con prompt estructurado
        // Retorna TransactionData con amount, merchant, date, category
    }
}

// GeminiService.java
@ApplicationScoped
public class GeminiService implements AIProvider {

    @ConfigProperty(name = "gemini.api.key")
    String apiKey;

    @ConfigProperty(name = "gemini.model", defaultValue = "gemini-pro")
    String model;

    @Override
    public TransactionData parseEmail(String subject, String body) {
        // Llamada a Google Gemini API
        // Retorna TransactionData
    }
}</code></pre>
                    </div>
                </div>

                <h3>Filtro de Display Name</h3>
                <div class="alert alert-info">
                    <strong>Nuevo:</strong> El sistema filtra transferencias donde el destinatario coincide con el
                    display name del usuario, evitando registrar transferencias a uno mismo como gastos.
                </div>
<pre><code>// DisplayNameFilter.java
@ApplicationScoped
public class DisplayNameFilter {

    public boolean shouldDiscard(TransactionData tx, String userDisplayName) {
        if (userDisplayName == null || userDisplayName.isBlank()) {
            return false;
        }

        String merchant = tx.getMerchant().toLowerCase();
        String displayName = userDisplayName.toLowerCase();

        // Filtra si el comercio/destinatario contiene el nombre del usuario
        return merchant.contains(displayName) ||
               similarity(merchant, displayName) > 0.8;
    }
}</code></pre>
            </section>

            <!-- PILASFI-EMAIL-SYNC SECTION -->
            <section id="pilasfi-email-sync" class="section">
                <h2 class="section-title">pilasfi-email-sync</h2>

                <div class="project-card">
                    <div class="project-card-header">
                        <h2>Servicio de Sincronizacion</h2>
                        <div>
                            <span class="badge badge-quarkus">Quarkus 3.x</span>
                            <span class="badge badge-gmail">Gmail API</span>
                            <span class="badge badge-outlook">MS Graph</span>
                            <span class="badge badge-pubsub">Pub/Sub</span>
                        </div>
                    </div>
                    <div class="project-card-body">
                        <p>Sincroniza emails de Gmail y Outlook, maneja tokens OAuth, implementa sync inicial (hacia atras)
                        e incremental, con bloqueo distribuido para evitar sincronizaciones concurrentes.</p>
                    </div>
                </div>

                <h3>Modos de Sincronizacion</h3>
                <table>
                    <tr>
                        <th>Modo</th>
                        <th>Descripcion</th>
                        <th>Direccion</th>
                        <th>Trigger</th>
                    </tr>
                    <tr>
                        <td><strong>Initial Sync</strong></td>
                        <td>Primera sincronizacion, procesa emails historicos</td>
                        <td>Hacia atras (mas reciente primero)</td>
                        <td>Primera configuracion de email</td>
                    </tr>
                    <tr>
                        <td><strong>Incremental Sync</strong></td>
                        <td>Solo emails nuevos desde ultima sincronizacion</td>
                        <td>Hacia adelante</td>
                        <td>Scheduler cada 15 minutos</td>
                    </tr>
                    <tr>
                        <td><strong>Manual Sync</strong></td>
                        <td>Sincronizacion forzada por usuario</td>
                        <td>Incremental</td>
                        <td>Boton en app</td>
                    </tr>
                </table>

                <h3>Flujo de Initial Sync (Backwards)</h3>
                <div class="diagram">
Usuario configura email por primera vez
                |
                v
+----------------------------------+
| 1. Recibe EmailConfigUpdatedEvent|
|    desde topic user-email-config |
+----------------------------------+
                |
                v
+----------------------------------+
| 2. Adquiere distributed lock     |
|    (15 min expiry)               |
+----------------------------------+
                |
                v
+----------------------------------+
| 3. Obtiene emails en BATCHES     |
|    - Gmail: 50 emails por batch  |
|    - Outlook: 50 emails por batch|
|    - Orden: MAS RECIENTE PRIMERO |
+----------------------------------+
                |
                v
+----------------------------------+
| 4. Por cada email:               |
|    - Filtra por remitentes banco |
|    - Publica a email-raw topic   |
+----------------------------------+
                |
                v
+----------------------------------+
| 5. Continua hacia atras hasta:   |
|    - Limite de 6 meses, o        |
|    - No hay mas emails           |
+----------------------------------+
                |
                v
+----------------------------------+
| 6. Libera lock                   |
|    Guarda lastSyncAt             |
+----------------------------------+
                </div>

                <h3>Bloqueo Distribuido</h3>
                <div class="collapsible open">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Implementacion del Lock</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code>// DistributedLockService.java
@ApplicationScoped
public class DistributedLockService {

    @Inject EntityManager em;

    private static final Duration LOCK_EXPIRY = Duration.ofMinutes(15);

    @Transactional
    public boolean tryAcquireLock(String userId, String lockType) {
        // 1. Verificar si existe lock activo
        SyncLock existingLock = em.createQuery(
            "SELECT l FROM SyncLock l WHERE l.userId = :userId " +
            "AND l.lockType = :lockType AND l.expiresAt > :now", SyncLock.class)
            .setParameter("userId", userId)
            .setParameter("lockType", lockType)
            .setParameter("now", Instant.now())
            .getResultStream()
            .findFirst()
            .orElse(null);

        if (existingLock != null) {
            return false;  // Lock activo, no sincronizar
        }

        // 2. Crear nuevo lock
        SyncLock lock = new SyncLock();
        lock.setUserId(userId);
        lock.setLockType(lockType);
        lock.setAcquiredAt(Instant.now());
        lock.setExpiresAt(Instant.now().plus(LOCK_EXPIRY));
        em.persist(lock);

        return true;
    }

    @Transactional
    public void releaseLock(String userId, String lockType) {
        em.createQuery(
            "DELETE FROM SyncLock l WHERE l.userId = :userId AND l.lockType = :lockType")
            .setParameter("userId", userId)
            .setParameter("lockType", lockType)
            .executeUpdate();
    }
}

// SyncLock.java - Entidad
@Entity
@Table(name = "sync_locks")
public class SyncLock {
    @Id @GeneratedValue
    private UUID id;
    private String userId;
    private String lockType;  // "INITIAL_SYNC", "INCREMENTAL_SYNC"
    private Instant acquiredAt;
    private Instant expiresAt;
}</code></pre>
                    </div>
                </div>

                <h3>Adaptadores de Email</h3>
                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Gmail Adapter</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code>// GmailAdapter.java
@ApplicationScoped
public class GmailAdapter implements EmailProviderAdapter {

    private static final int BATCH_SIZE = 50;

    @Override
    public List&lt;RawEmail&gt; fetchEmails(EmailConfig config, FetchDirection direction) {
        Gmail gmail = buildGmailClient(config.getAccessToken());

        // Query para emails de bancos
        String query = buildBankQuery();  // "from:notificaciones@bcp.com.pe OR from:..."

        ListMessagesResponse response = gmail.users().messages()
            .list("me")
            .setQ(query)
            .setMaxResults(BATCH_SIZE)
            .execute();

        List&lt;RawEmail&gt; emails = new ArrayList&lt;&gt;();
        for (Message msg : response.getMessages()) {
            Message full = gmail.users().messages().get("me", msg.getId())
                .setFormat("full")
                .execute();

            emails.add(convertToRawEmail(full));
        }

        // Ordenar segun direccion
        if (direction == FetchDirection.BACKWARDS) {
            emails.sort(Comparator.comparing(RawEmail::getDate).reversed());
        }

        return emails;
    }

    @Override
    public TokenPair refreshToken(String refreshToken) {
        // Usa OAuth2 para refrescar el access token
        GoogleTokenResponse response = new GoogleRefreshTokenRequest(
            new NetHttpTransport(),
            GsonFactory.getDefaultInstance(),
            refreshToken,
            clientId,
            clientSecret
        ).execute();

        return new TokenPair(
            response.getAccessToken(),
            response.getRefreshToken(),
            Instant.now().plusSeconds(response.getExpiresInSeconds())
        );
    }
}</code></pre>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Outlook Adapter (MS Graph)</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code>// OutlookAdapter.java
@ApplicationScoped
public class OutlookAdapter implements EmailProviderAdapter {

    private static final int BATCH_SIZE = 50;
    private static final String GRAPH_API = "https://graph.microsoft.com/v1.0";

    @Override
    public List&lt;RawEmail&gt; fetchEmails(EmailConfig config, FetchDirection direction) {
        GraphServiceClient client = buildGraphClient(config.getAccessToken());

        // Filtro para emails de bancos
        String filter = buildBankFilter();

        MessageCollectionPage messages = client.me().messages()
            .buildRequest()
            .filter(filter)
            .top(BATCH_SIZE)
            .orderBy(direction == FetchDirection.BACKWARDS ?
                "receivedDateTime desc" : "receivedDateTime asc")
            .get();

        return messages.getCurrentPage().stream()
            .map(this::convertToRawEmail)
            .collect(Collectors.toList());
    }

    @Override
    public TokenPair refreshToken(String refreshToken) {
        // Azure AD OAuth2 token refresh
        HttpRequest request = HttpRequest.newBuilder()
            .uri(URI.create("https://login.microsoftonline.com/common/oauth2/v2.0/token"))
            .POST(HttpRequest.BodyPublishers.ofString(
                "grant_type=refresh_token" +
                "&refresh_token=" + refreshToken +
                "&client_id=" + clientId +
                "&client_secret=" + clientSecret +
                "&scope=Mail.Read offline_access"
            ))
            .header("Content-Type", "application/x-www-form-urlencoded")
            .build();

        // Parse response and return TokenPair
    }
}</code></pre>
                    </div>
                </div>

                <h3>Token Refresh Flow</h3>
                <div class="diagram">
Scheduler detecta token proximo a expirar (< 5 min)
                    |
                    v
+----------------------------------+
| 1. EmailSyncService.refreshToken |
|    - Llama al adapter correcto   |
+----------------------------------+
                    |
                    v
+----------------------------------+
| 2. Adapter hace OAuth refresh    |
|    - Gmail: Google OAuth         |
|    - Outlook: Azure AD           |
+----------------------------------+
                    |
                    v
+----------------------------------+
| 3. Publica TokenRefreshedEvent   |
|    al topic token-refreshed      |
+----------------------------------+
                    |
                    v
+----------------------------------+
| 4. pilasfi-quarkus consume       |
|    y actualiza tokens en DB      |
+----------------------------------+
                </div>
            </section>

            <!-- PILASFI-SYNC-SCHEDULER SECTION -->
            <section id="pilasfi-sync-scheduler" class="section">
                <h2 class="section-title">pilasfi-sync-scheduler</h2>

                <div class="project-card">
                    <div class="project-card-header">
                        <h2>Scheduler Distribuido</h2>
                        <div>
                            <span class="badge badge-quarkus">Quarkus 3.x</span>
                            <span class="badge badge-pubsub">Pub/Sub</span>
                            <span class="badge badge-postgres">PostgreSQL</span>
                            <span class="badge badge-gcp">Cloud Scheduler</span>
                        </div>
                    </div>
                    <div class="project-card-body">
                        <p>Microservicio dedicado a orquestar la sincronizacion periodica de emails.
                        Resuelve el problema de escalabilidad horizontal al centralizar el scheduling
                        y usar marcado atomico para evitar sincronizaciones duplicadas.</p>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>Problema resuelto:</strong> Sin este servicio, si pilasfi-quarkus escala a N instancias,
                    cada instancia ejecutaria su propio scheduler, causando N sincronizaciones duplicadas por usuario.
                    El scheduler distribuido garantiza que cada email_config se sincroniza exactamente una vez por ciclo.
                </div>

                <h3>Arquitectura</h3>
                <div class="diagram">
+------------------+     HTTP POST /trigger      +-------------------------+
| Cloud Scheduler  |--------------------------->| pilasfi-sync-scheduler  |
| (GCP Managed)    |     (cada 5 minutos)       | (Cloud Run)             |
+------------------+                            +-------------------------+
                                                           |
                                                           v
                                                +-------------------------+
                                                | 1. Buscar email_configs |
                                                |    WHERE next_sync_at   |
                                                |    <= NOW AND status    |
                                                |    = 'IDLE'             |
                                                +-------------------------+
                                                           |
                                                           v
                                                +-------------------------+
                                                | 2. Atomic Marking       |
                                                |    UPDATE email_configs |
                                                |    SET status='QUEUED'  |
                                                |    WHERE id=? AND       |
                                                |    status='IDLE'        |
                                                +-------------------------+
                                                           |
                                                           v
                                                +-------------------------+
                                                | 3. Crear SyncJob        |
                                                |    (Outbox Pattern)     |
                                                +-------------------------+
                                                           |
                                                           v
                                                +-------------------------+
                                                | 4. Publicar a Pub/Sub   |
                                                |    sync-email-request   |
                                                |    con ordering key     |
                                                +-------------------------+
                                                           |
                                                           v
                                                +-------------------------+
                                                | pilasfi-email-sync      |
                                                | procesa el sync request |
                                                +-------------------------+
                </div>

                <h3>Modelo de Datos</h3>
                <table>
                    <tr>
                        <th>Tabla</th>
                        <th>Proposito</th>
                        <th>Campos Clave</th>
                    </tr>
                    <tr>
                        <td><code>email_configs</code></td>
                        <td>Campos adicionales para scheduling</td>
                        <td><code>next_sync_at</code>, <code>sync_status</code> (IDLE, QUEUED, IN_PROGRESS, FAILED)</td>
                    </tr>
                    <tr>
                        <td><code>sync_jobs</code></td>
                        <td>Outbox pattern - jobs pendientes</td>
                        <td><code>email_config_id</code>, <code>job_type</code>, <code>status</code>, <code>partition_key</code></td>
                    </tr>
                    <tr>
                        <td><code>sync_locks</code></td>
                        <td>Bloqueo distribuido</td>
                        <td><code>resource_id</code>, <code>locked_by</code>, <code>expires_at</code></td>
                    </tr>
                </table>

                <h3>Prevencion de Duplicados</h3>
                <div class="collapsible open">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Atomic Marking Pattern</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code>// EmailConfigEntity.java - Marcado atomico
public static int markAsQueued(Long configId) {
    return getEntityManager()
        .createQuery("UPDATE EmailConfigEntity e " +
                     "SET e.syncStatus = 'QUEUED' " +
                     "WHERE e.id = :id AND e.syncStatus = 'IDLE'")
        .setParameter("id", configId)
        .executeUpdate();
}

// SyncSchedulerService.java - Uso del marcado atomico
@Transactional
public TriggerSyncResponse triggerSync() {
    LocalDateTime now = LocalDateTime.now(ZoneOffset.UTC);
    List&lt;EmailConfigEntity&gt; dueConfigs = EmailConfigEntity.findDueForSync(now, batchSize);

    for (EmailConfigEntity config : dueConfigs) {
        // UPDATE atomico - retorna 0 si ya fue marcado por otra instancia
        int updated = EmailConfigEntity.markAsQueued(config.id);

        if (updated == 0) {
            // Otra instancia ya proceso este config, skip
            continue;
        }

        // Crear job en outbox y publicar a Pub/Sub
        SyncJobEntity job = SyncJobEntity.create(config, config.user, JobType.INCREMENTAL);
        job.persist();
        eventPublisher.publishSyncRequest(buildSyncRequestEvent(job, config));
    }

    return new TriggerSyncResponse(published, skipped, errors);
}</code></pre>
                    </div>
                </div>

                <h3>Configuracion Terraform</h3>
                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Cloud Scheduler Job</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code># terraform.tfvars
scheduler_jobs = {
  "email-sync-trigger" = {
    schedule    = "*/5 * * * *"  # Cada 5 minutos
    time_zone   = "America/Guayaquil"
    target_url  = "https://pilasfi-sync-scheduler-xxx.run.app/api/scheduler/trigger"
    http_method = "POST"
    description = "Trigger distributed email sync"
  }
}

# El modulo cloud-scheduler usa OIDC token para autenticacion
resource "google_cloud_scheduler_job" "jobs" {
  for_each = var.scheduler_jobs

  http_target {
    uri         = each.value.target_url
    http_method = each.value.http_method

    oidc_token {
      service_account_email = var.service_account_email
      audience              = each.value.target_url
    }
  }
}</code></pre>
                    </div>
                </div>

                <h3>Estructura del Proyecto</h3>
                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>pilasfi-sync-scheduler - Paquetes</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code>src/main/java/com/pilasfi/scheduler/
├── domain/
│   ├── event/
│   │   └── SyncRequestEvent.java        # Evento de sincronizacion
│   └── model/
│       ├── JobType.java                 # INITIAL, INCREMENTAL
│       └── SyncStatus.java              # IDLE, QUEUED, IN_PROGRESS, FAILED
├── application/
│   ├── port/
│   │   ├── input/
│   │   │   └── TriggerSyncUseCase.java  # Puerto de entrada
│   │   └── output/
│   │       └── SyncEventPublisher.java  # Puerto de salida
│   ├── service/
│   │   └── SyncSchedulerService.java    # Implementacion del use case
│   └── dto/
│       └── TriggerSyncResponse.java     # DTO de respuesta
└── infrastructure/
    ├── adapter/
    │   ├── input/
    │   │   └── rest/
    │   │       └── SchedulerResource.java   # Endpoint /trigger
    │   └── output/
    │       └── messaging/
    │           └── PubSubSyncEventPublisher.java
    └── persistence/
        └── entity/
            ├── EmailConfigEntity.java   # Extiende con campos de sync
            ├── SyncJobEntity.java       # Jobs outbox
            └── SyncLockEntity.java      # Locks distribuidos</code></pre>
                    </div>
                </div>

                <h3>Endpoint REST</h3>
                <table>
                    <tr>
                        <th>Metodo</th>
                        <th>Path</th>
                        <th>Descripcion</th>
                        <th>Auth</th>
                    </tr>
                    <tr>
                        <td><code>POST</code></td>
                        <td><code>/api/scheduler/trigger</code></td>
                        <td>Dispara ciclo de sincronizacion</td>
                        <td>OIDC (Cloud Scheduler)</td>
                    </tr>
                    <tr>
                        <td><code>GET</code></td>
                        <td><code>/q/health/ready</code></td>
                        <td>Health check readiness</td>
                        <td>Ninguna</td>
                    </tr>
                    <tr>
                        <td><code>GET</code></td>
                        <td><code>/q/health/live</code></td>
                        <td>Health check liveness</td>
                        <td>Ninguna</td>
                    </tr>
                </table>
            </section>

            <!-- APP-PILAS-FE SECTION -->
            <section id="app-pilas-fe" class="section">
                <h2 class="section-title">app-pilas-fe (Flutter)</h2>

                <div class="project-card">
                    <div class="project-card-header">
                        <h2>Aplicacion Movil</h2>
                        <div>
                            <span class="badge badge-flutter">Flutter 3.x</span>
                            <span class="badge badge-firebase">Firebase</span>
                        </div>
                    </div>
                    <div class="project-card-body">
                        <p>Aplicacion movil multiplataforma (iOS/Android) construida con Flutter,
                        usando Riverpod para state management y Firebase para autenticacion.</p>
                    </div>
                </div>

                <h3>Estructura del Proyecto</h3>
<pre><code>lib/
├── main.dart                    # Entry point
├── app/
│   ├── app.dart                 # MaterialApp + GoRouter
│   └── theme/
│       └── app_theme.dart       # Tema de la aplicacion
├── core/
│   ├── constants/
│   │   └── api_constants.dart   # URLs del backend
│   ├── network/
│   │   ├── dio_client.dart      # Cliente HTTP configurado
│   │   └── interceptors/
│   │       └── auth_interceptor.dart
│   └── utils/
│       └── date_utils.dart
├── features/
│   ├── auth/
│   │   ├── data/
│   │   │   ├── repositories/
│   │   │   │   └── auth_repository_impl.dart
│   │   │   └── datasources/
│   │   │       └── firebase_auth_datasource.dart
│   │   ├── domain/
│   │   │   ├── entities/
│   │   │   │   └── user.dart
│   │   │   └── repositories/
│   │   │       └── auth_repository.dart
│   │   └── presentation/
│   │       ├── providers/
│   │       │   └── auth_provider.dart
│   │       ├── screens/
│   │       │   └── login_screen.dart
│   │       └── widgets/
│   │           └── google_sign_in_button.dart
│   ├── transactions/
│   │   ├── data/
│   │   │   └── repositories/
│   │   │       └── transaction_repository_impl.dart
│   │   ├── domain/
│   │   │   ├── entities/
│   │   │   │   └── transaction.dart
│   │   │   └── usecases/
│   │   │       ├── get_transactions.dart
│   │   │       └── create_transaction.dart
│   │   └── presentation/
│   │       ├── providers/
│   │       │   └── transactions_provider.dart
│   │       ├── screens/
│   │       │   ├── transactions_screen.dart
│   │       │   └── transaction_detail_screen.dart
│   │       └── widgets/
│   │           └── transaction_card.dart
│   ├── email_sync/
│   │   ├── data/
│   │   │   └── repositories/
│   │   │       └── email_config_repository_impl.dart
│   │   ├── domain/
│   │   │   └── entities/
│   │   │       └── email_config.dart
│   │   └── presentation/
│   │       ├── providers/
│   │       │   └── email_sync_provider.dart
│   │       ├── screens/
│   │       │   └── email_config_screen.dart
│   │       └── widgets/
│   │           ├── gmail_connect_button.dart
│   │           └── outlook_connect_button.dart
│   └── profile/
│       └── presentation/
│           ├── screens/
│           │   └── profile_screen.dart
│           └── providers/
│               └── profile_provider.dart
└── shared/
    └── widgets/
        └── loading_indicator.dart</code></pre>

                <h3>State Management (Riverpod)</h3>
                <div class="collapsible open">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Providers Principales</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code>// auth_provider.dart
@riverpod
class Auth extends _$Auth {
  @override
  AsyncValue&lt;User?&gt; build() {
    return const AsyncValue.loading();
  }

  Future&lt;void&gt; signInWithGoogle() async {
    state = const AsyncValue.loading();
    try {
      final user = await ref.read(authRepositoryProvider).signInWithGoogle();
      state = AsyncValue.data(user);
    } catch (e, st) {
      state = AsyncValue.error(e, st);
    }
  }

  Future&lt;void&gt; signOut() async {
    await ref.read(authRepositoryProvider).signOut();
    state = const AsyncValue.data(null);
  }
}

// transactions_provider.dart
@riverpod
class Transactions extends _$Transactions {
  @override
  Future&lt;List&lt;Transaction&gt;&gt; build() async {
    return ref.read(transactionRepositoryProvider).getTransactions();
  }

  Future&lt;void&gt; refresh() async {
    state = const AsyncValue.loading();
    state = AsyncValue.data(
      await ref.read(transactionRepositoryProvider).getTransactions()
    );
  }

  Future&lt;void&gt; createTransaction(CreateTransactionDto dto) async {
    await ref.read(transactionRepositoryProvider).createTransaction(dto);
    await refresh();
  }
}

// email_sync_provider.dart
@riverpod
class EmailSync extends _$EmailSync {
  @override
  Future&lt;EmailConfig?&gt; build() async {
    return ref.read(emailConfigRepositoryProvider).getConfig();
  }

  Future&lt;void&gt; connectGmail(String authCode) async {
    state = const AsyncValue.loading();
    await ref.read(emailConfigRepositoryProvider).connectGmail(authCode);
    state = AsyncValue.data(
      await ref.read(emailConfigRepositoryProvider).getConfig()
    );
  }

  Future&lt;void&gt; triggerSync() async {
    await ref.read(emailConfigRepositoryProvider).triggerSync();
  }
}</code></pre>
                    </div>
                </div>

                <h3>Flujo OAuth en App</h3>
                <div class="diagram">
Usuario toca "Conectar Gmail"
            |
            v
+----------------------------------+
| 1. google_sign_in package        |
|    abre browser para OAuth       |
+----------------------------------+
            |
            v
+----------------------------------+
| 2. Usuario autoriza en Google    |
|    Scopes: email, gmail.readonly |
+----------------------------------+
            |
            v
+----------------------------------+
| 3. App recibe auth code          |
|    via deep link callback        |
+----------------------------------+
            |
            v
+----------------------------------+
| 4. POST /api/email-config        |
|    con auth code                 |
+----------------------------------+
            |
            v
+----------------------------------+
| 5. Backend intercambia code      |
|    por tokens y guarda           |
+----------------------------------+
            |
            v
+----------------------------------+
| 6. Backend publica evento        |
|    a user-email-config topic     |
+----------------------------------+
            |
            v
+----------------------------------+
| 7. email-sync inicia             |
|    sincronizacion inicial        |
+----------------------------------+
                </div>
            </section>

            <!-- INFRA-GCP SECTION -->
            <section id="infra-gcp" class="section">
                <h2 class="section-title">pilasfi-infra-gcp (Terraform)</h2>

                <div class="project-card">
                    <div class="project-card-header">
                        <h2>Infraestructura GCP</h2>
                        <div>
                            <span class="badge badge-terraform">Terraform</span>
                            <span class="badge badge-gcp">GCP</span>
                        </div>
                    </div>
                    <div class="project-card-body">
                        <p>Infraestructura como codigo usando Terraform para desplegar en Google Cloud Platform.
                        Incluye Cloud Run, Cloud SQL, Pub/Sub y Secret Manager.</p>
                    </div>
                </div>

                <h3>Estructura de Terraform</h3>
<pre><code>terraform/
├── main.tf                 # Provider configuration
├── variables.tf            # Input variables
├── outputs.tf              # Output values
├── versions.tf             # Terraform version constraints
├── modules/
│   ├── cloud-run/
│   │   ├── main.tf         # Cloud Run service definition
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── cloud-sql/
│   │   ├── main.tf         # PostgreSQL instance
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── pubsub/
│   │   ├── main.tf         # Topics and subscriptions
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── secret-manager/
│   │   ├── main.tf         # Secrets storage
│   │   ├── variables.tf
│   │   └── outputs.tf
│   └── networking/
│       ├── main.tf         # VPC, subnets
│       ├── variables.tf
│       └── outputs.tf
└── environments/
    ├── dev/
    │   ├── main.tf
    │   └── terraform.tfvars
    └── prod/
        ├── main.tf
        └── terraform.tfvars</code></pre>

                <h3>Recursos Principales</h3>
                <div class="collapsible open">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Cloud Run Services</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code># modules/cloud-run/main.tf

resource "google_cloud_run_service" "pilasfi_api" {
  name     = "pilasfi-api"
  location = var.region

  template {
    spec {
      containers {
        image = var.api_image

        ports {
          container_port = 8080
        }

        env {
          name  = "QUARKUS_DATASOURCE_JDBC_URL"
          value = "jdbc:postgresql:///${var.db_name}?cloudSqlInstance=${var.cloud_sql_connection}&socketFactory=com.google.cloud.sql.postgres.SocketFactory"
        }

        env {
          name = "QUARKUS_DATASOURCE_PASSWORD"
          value_from {
            secret_key_ref {
              name = google_secret_manager_secret.db_password.secret_id
              key  = "latest"
            }
          }
        }

        resources {
          limits = {
            cpu    = "1000m"
            memory = "512Mi"
          }
        }
      }

      service_account_name = google_service_account.cloud_run_sa.email
    }

    metadata {
      annotations = {
        "autoscaling.knative.dev/minScale"      = "0"
        "autoscaling.knative.dev/maxScale"      = "10"
        "run.googleapis.com/cloudsql-instances" = var.cloud_sql_connection
      }
    }
  }

  traffic {
    percent         = 100
    latest_revision = true
  }
}

resource "google_cloud_run_service" "pilasfi_parser" {
  name     = "pilasfi-parser"
  location = var.region

  template {
    spec {
      containers {
        image = var.parser_image

        env {
          name = "OPENAI_API_KEY"
          value_from {
            secret_key_ref {
              name = google_secret_manager_secret.openai_key.secret_id
              key  = "latest"
            }
          }
        }

        env {
          name = "GEMINI_API_KEY"
          value_from {
            secret_key_ref {
              name = google_secret_manager_secret.gemini_key.secret_id
              key  = "latest"
            }
          }
        }
      }
    }
  }
}

resource "google_cloud_run_service" "pilasfi_email_sync" {
  name     = "pilasfi-email-sync"
  location = var.region

  template {
    spec {
      containers {
        image = var.email_sync_image

        env {
          name = "GOOGLE_CLIENT_SECRET"
          value_from {
            secret_key_ref {
              name = google_secret_manager_secret.google_oauth.secret_id
              key  = "latest"
            }
          }
        }
      }
    }
  }
}</code></pre>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Pub/Sub Topics</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code># modules/pubsub/main.tf

resource "google_pubsub_topic" "user_email_config" {
  name = "user-email-config"

  message_retention_duration = "604800s"  # 7 days
}

resource "google_pubsub_topic" "email_raw" {
  name = "email-raw"

  message_retention_duration = "86400s"  # 1 day
}

resource "google_pubsub_topic" "email_transaction" {
  name = "email-transaction"

  message_retention_duration = "604800s"  # 7 days
}

resource "google_pubsub_topic" "token_refreshed" {
  name = "token-refreshed"

  message_retention_duration = "86400s"  # 1 day
}

# Subscriptions
resource "google_pubsub_subscription" "email_sync_config_sub" {
  name  = "email-sync-config-subscription"
  topic = google_pubsub_topic.user_email_config.name

  push_config {
    push_endpoint = "${google_cloud_run_service.pilasfi_email_sync.status[0].url}/pubsub/email-config"

    oidc_token {
      service_account_email = google_service_account.pubsub_invoker.email
    }
  }

  ack_deadline_seconds = 60

  retry_policy {
    minimum_backoff = "10s"
    maximum_backoff = "600s"
  }
}

resource "google_pubsub_subscription" "parser_email_raw_sub" {
  name  = "parser-email-raw-subscription"
  topic = google_pubsub_topic.email_raw.name

  push_config {
    push_endpoint = "${google_cloud_run_service.pilasfi_parser.status[0].url}/pubsub/email-raw"
  }
}

resource "google_pubsub_subscription" "api_transaction_sub" {
  name  = "api-transaction-subscription"
  topic = google_pubsub_topic.email_transaction.name

  push_config {
    push_endpoint = "${google_cloud_run_service.pilasfi_api.status[0].url}/pubsub/transaction"
  }
}</code></pre>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Cloud SQL (PostgreSQL)</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code># modules/cloud-sql/main.tf

resource "google_sql_database_instance" "pilasfi" {
  name             = "pilasfi-db-instance"
  database_version = "POSTGRES_15"
  region           = var.region

  settings {
    tier = "db-f1-micro"  # Dev tier

    ip_configuration {
      ipv4_enabled    = false
      private_network = var.vpc_id
    }

    backup_configuration {
      enabled            = true
      start_time         = "03:00"
      binary_log_enabled = false

      backup_retention_settings {
        retained_backups = 7
      }
    }

    database_flags {
      name  = "max_connections"
      value = "100"
    }
  }

  deletion_protection = true
}

resource "google_sql_database" "pilasfi_api" {
  name     = "pilasfi_api"
  instance = google_sql_database_instance.pilasfi.name
}

resource "google_sql_database" "pilasfi_parser" {
  name     = "pilasfi_parser"
  instance = google_sql_database_instance.pilasfi.name
}

resource "google_sql_database" "pilasfi_email_sync" {
  name     = "pilasfi_email_sync"
  instance = google_sql_database_instance.pilasfi.name
}

resource "google_sql_user" "app_user" {
  name     = "pilasfi_app"
  instance = google_sql_database_instance.pilasfi.name
  password = random_password.db_password.result
}</code></pre>
                    </div>
                </div>

                <h3>CI/CD con GitHub Actions</h3>
<pre><code># .github/workflows/deploy.yml

name: Deploy to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and Push Image
        run: |
          gcloud builds submit \
            --tag gcr.io/$PROJECT_ID/pilasfi-api:${{ github.sha }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy pilasfi-api \
            --image gcr.io/$PROJECT_ID/pilasfi-api:${{ github.sha }} \
            --region $REGION \
            --platform managed</code></pre>
            </section>

            <!-- INFRA-APPS SECTION -->
            <section id="infra-apps" class="section">
                <h2 class="section-title">pilasfi-infra-apps (Kubernetes)</h2>

                <div class="project-card">
                    <div class="project-card-header">
                        <h2>Kubernetes Manifests (Alternativo)</h2>
                        <div>
                            <span class="badge badge-k8s">Kubernetes</span>
                            <span class="badge" style="background:#EF652A;color:#fff;">ArgoCD</span>
                            <span class="badge" style="background:#326CE5;color:#fff;">Kustomize</span>
                        </div>
                    </div>
                    <div class="project-card-body">
                        <p>Manifiestos Kubernetes alternativos para despliegue on-premise o en clusters GKE.
                        Usa Kustomize para overlays y ArgoCD para GitOps.</p>
                    </div>
                </div>

                <h3>Estructura del Repositorio</h3>
<pre><code>pilasfi-infra-apps/
├── apps/
│   └── pilasfi/
│       ├── base/
│       │   ├── kustomization.yaml
│       │   ├── namespace.yaml
│       │   ├── api/
│       │   │   ├── deployment.yaml
│       │   │   ├── service.yaml
│       │   │   ├── configmap.yaml
│       │   │   └── kustomization.yaml
│       │   ├── parser/
│       │   │   ├── deployment.yaml
│       │   │   ├── service.yaml
│       │   │   └── kustomization.yaml
│       │   ├── email-sync/
│       │   │   ├── deployment.yaml
│       │   │   ├── service.yaml
│       │   │   └── kustomization.yaml
│       │   └── kafka/
│       │       ├── kafka-cluster.yaml      # Strimzi Kafka
│       │       ├── kafka-topics.yaml
│       │       └── kustomization.yaml
│       └── overlays/
│           ├── dev/
│           │   ├── kustomization.yaml
│           │   └── patches/
│           │       └── replicas-patch.yaml
│           └── prod/
│               ├── kustomization.yaml
│               └── patches/
│                   ├── replicas-patch.yaml
│                   └── resources-patch.yaml
├── argocd/
│   ├── applicationset.yaml
│   └── projects/
│       └── pilasfi-project.yaml
└── operators/
    ├── strimzi/
    │   └── kafka-operator.yaml
    └── zalando/
        └── postgres-operator.yaml</code></pre>

                <h3>Componentes Kubernetes</h3>
                <table>
                    <tr>
                        <th>Componente</th>
                        <th>Operador/Tipo</th>
                        <th>Descripcion</th>
                    </tr>
                    <tr>
                        <td>Kafka</td>
                        <td>Strimzi Operator</td>
                        <td>Cluster Kafka con topics para mensajeria</td>
                    </tr>
                    <tr>
                        <td>PostgreSQL</td>
                        <td>Zalando Operator</td>
                        <td>Cluster PostgreSQL con HA</td>
                    </tr>
                    <tr>
                        <td>Secrets</td>
                        <td>Sealed Secrets</td>
                        <td>Secretos encriptados para GitOps</td>
                    </tr>
                    <tr>
                        <td>Ingress</td>
                        <td>NGINX Ingress</td>
                        <td>Routing HTTP/HTTPS</td>
                    </tr>
                </table>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Strimzi Kafka Cluster</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code># apps/pilasfi/base/kafka/kafka-cluster.yaml
apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: pilasfi-kafka
  namespace: pilasfi
spec:
  kafka:
    version: 3.6.0
    replicas: 3
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
    config:
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      default.replication.factor: 3
      min.insync.replicas: 2
    storage:
      type: persistent-claim
      size: 100Gi
      class: standard
  zookeeper:
    replicas: 3
    storage:
      type: persistent-claim
      size: 100Gi
      class: standard

---
# kafka-topics.yaml
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: user-email-config
  labels:
    strimzi.io/cluster: pilasfi-kafka
spec:
  partitions: 3
  replicas: 3
  config:
    retention.ms: 604800000

---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: email-raw
  labels:
    strimzi.io/cluster: pilasfi-kafka
spec:
  partitions: 6
  replicas: 3
  config:
    retention.ms: 86400000

---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: email-transaction
  labels:
    strimzi.io/cluster: pilasfi-kafka
spec:
  partitions: 3
  replicas: 3</code></pre>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>ArgoCD ApplicationSet</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code># argocd/applicationset.yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: pilasfi-apps
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          - env: dev
            cluster: https://kubernetes.default.svc
          - env: prod
            cluster: https://prod-cluster.example.com
  template:
    metadata:
      name: 'pilasfi-{{env}}'
    spec:
      project: pilasfi
      source:
        repoURL: https://github.com/polarpipeline/pilasfi-infra-apps.git
        targetRevision: HEAD
        path: 'apps/pilasfi/overlays/{{env}}'
      destination:
        server: '{{cluster}}'
        namespace: pilasfi-{{env}}
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true</code></pre>
                    </div>
                </div>
            </section>

            <!-- DISTRIBUTED SCHEDULER FLOW SECTION -->
            <section id="distributed-scheduler" class="section">
                <h2 class="section-title">Arquitectura del Scheduler Distribuido</h2>

                <div class="alert alert-success">
                    <strong>Escalabilidad horizontal:</strong> Esta arquitectura permite que pilasfi-quarkus escale
                    a multiples instancias sin duplicar sincronizaciones. El scheduler centralizado garantiza
                    que cada email_config se procese exactamente una vez por ciclo.
                </div>

                <h3>Problema Original</h3>
                <div class="diagram">
ANTES (Scheduler en pilasfi-quarkus):
=====================================

+-------------------+     +-------------------+     +-------------------+
| pilasfi-quarkus   |     | pilasfi-quarkus   |     | pilasfi-quarkus   |
| Instancia 1       |     | Instancia 2       |     | Instancia 3       |
| @Scheduled(5m)    |     | @Scheduled(5m)    |     | @Scheduled(5m)    |
+-------------------+     +-------------------+     +-------------------+
         |                         |                         |
         v                         v                         v
+------------------------------------------------------------------+
| Cada instancia ejecuta su propio scheduler                        |
| = 3x sincronizaciones duplicadas por cada email_config            |
| = Race conditions, mensajes duplicados, costos innecesarios       |
+------------------------------------------------------------------+
                </div>

                <h3>Solucion Implementada</h3>
                <div class="diagram">
DESPUES (Scheduler Distribuido):
================================

+------------------+
| Cloud Scheduler  |  (GCP Managed Cron - Single Source of Truth)
| (cada 5 min)     |
+------------------+
         |
         | HTTP POST /api/scheduler/trigger
         v
+------------------------+
| pilasfi-sync-scheduler |  (Single instance, stateless)
| (Cloud Run)            |
+------------------------+
         |
         | 1. SELECT email_configs WHERE next_sync_at <= NOW AND status = 'IDLE'
         | 2. UPDATE email_configs SET status = 'QUEUED' WHERE id = ? AND status = 'IDLE'
         |    (Atomic - returns 0 if already queued by concurrent request)
         | 3. INSERT INTO sync_jobs (outbox pattern)
         | 4. PUBLISH to sync-email-request topic
         v
+------------------------+     +------------------------+     +------------------------+
| pilasfi-email-sync     |     | pilasfi-email-sync     |     | pilasfi-email-sync     |
| Instancia 1            |     | Instancia 2            |     | Instancia 3            |
+------------------------+     +------------------------+     +------------------------+
         |                              |                              |
         | Cada instancia procesa       | Pub/Sub garantiza que        | mensajes distintos
         | diferentes SyncRequestEvents | cada mensaje se entrega      | (ordering by userId)
         v                              v                              v
+------------------------------------------------------------------+
| Resultado: Cada email_config sincronizado exactamente 1 vez       |
| Sin duplicados, sin race conditions, escalable horizontalmente    |
+------------------------------------------------------------------+
                </div>

                <h3>Flujo Detallado del Scheduler</h3>
                <div class="flow-step">
                    <span class="flow-step-number">1</span>
                    <strong>Cloud Scheduler dispara trigger</strong>
                    <p>Cada 5 minutos, Cloud Scheduler hace HTTP POST a /api/scheduler/trigger con OIDC token</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">2</span>
                    <strong>Buscar configs pendientes de sync</strong>
                    <p>SELECT de email_configs WHERE next_sync_at &lt;= NOW AND sync_status = 'IDLE' LIMIT 100</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">3</span>
                    <strong>Atomic marking (por cada config)</strong>
                    <p>UPDATE email_configs SET sync_status = 'QUEUED' WHERE id = ? AND sync_status = 'IDLE'.
                    Si retorna 0 rows affected, significa que otra request ya lo proceso - skip.</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">4</span>
                    <strong>Crear SyncJob en outbox</strong>
                    <p>INSERT en sync_jobs con email_config_id, job_type (INCREMENTAL), partition_key (userId % partitions)</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">5</span>
                    <strong>Publicar a Pub/Sub</strong>
                    <p>SyncRequestEvent publicado a sync-email-request con ordering key = "user-{userId}"</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">6</span>
                    <strong>pilasfi-email-sync consume</strong>
                    <p>Adquiere distributed lock, ejecuta sync, actualiza next_sync_at y sync_status = 'IDLE'</p>
                </div>

                <h3>Patrones Utilizados</h3>
                <table>
                    <tr>
                        <th>Patron</th>
                        <th>Proposito</th>
                        <th>Implementacion</th>
                    </tr>
                    <tr>
                        <td><strong>Atomic Marking</strong></td>
                        <td>Prevenir duplicados en ambiente concurrente</td>
                        <td>UPDATE con WHERE status = 'IDLE' en transaccion</td>
                    </tr>
                    <tr>
                        <td><strong>Outbox Pattern</strong></td>
                        <td>Garantizar consistencia entre DB y mensajeria</td>
                        <td>sync_jobs table como staging area</td>
                    </tr>
                    <tr>
                        <td><strong>Distributed Lock</strong></td>
                        <td>Prevenir sync concurrente del mismo usuario</td>
                        <td>sync_locks table con expiry</td>
                    </tr>
                    <tr>
                        <td><strong>Ordering Keys</strong></td>
                        <td>Garantizar orden de mensajes por usuario</td>
                        <td>Pub/Sub ordering key = "user-{userId}"</td>
                    </tr>
                </table>

                <h3>Configuracion de Variables</h3>
                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>application.properties</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
<pre><code># pilasfi-sync-scheduler application.properties
quarkus.http.port=8082

# Pub/Sub configuration
scheduler.pubsub.topic.sync-request=${PUBSUB_TOPIC_SYNC_REQUEST:sync-email-request}
quarkus.google.cloud.project-id=${GOOGLE_CLOUD_PROJECT:pilasfi-dev}

# Scheduler configuration
scheduler.batch-size=${SCHEDULER_BATCH_SIZE:100}

# Database (shared with pilasfi-quarkus)
quarkus.datasource.db-kind=postgresql
quarkus.datasource.jdbc.url=${JDBC_URL:jdbc:postgresql://localhost:5432/pilasfi}
quarkus.datasource.username=${DB_USER:postgres}
quarkus.datasource.password=${DB_PASSWORD:postgres}</code></pre>
                    </div>
                </div>
            </section>

            <!-- EMAIL SYNC FLOW SECTION -->
            <section id="email-sync-flow" class="section">
                <h2 class="section-title">Flujo Completo: Sincronizacion de Email</h2>

                <div class="alert alert-info">
                    <strong>Nota:</strong> Este flujo describe tanto la sincronizacion inicial (cuando el usuario
                    conecta su email) como la sincronizacion periodica (disparada por pilasfi-sync-scheduler).
                </div>

                <div class="flow-step">
                    <span class="flow-step-number">1</span>
                    <strong>Usuario conecta Gmail en la app</strong>
                    <p>Abre OAuth consent screen, autoriza acceso a Gmail, app recibe auth code</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">2</span>
                    <strong>POST /api/email-config (pilasfi-quarkus)</strong>
                    <p>Intercambia auth code por tokens, guarda en EmailConfig, publica EmailConfigUpdatedEvent</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">3</span>
                    <strong>pilasfi-email-sync consume evento</strong>
                    <p>Recibe de topic user-email-config, intenta adquirir distributed lock</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">4</span>
                    <strong>Initial Sync (Backwards)</strong>
                    <p>Obtiene emails en batches de 50, mas reciente primero, filtra por remitentes bancarios</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">5</span>
                    <strong>Publica a email-raw topic</strong>
                    <p>Cada email filtrado se publica como RawEmailEvent con userId, messageId, subject, body</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">6</span>
                    <strong>pilasfi-parser-service procesa</strong>
                    <p>Pipeline: Blacklist check → Regex DB → Discard check → AI fallback → Category parser → Display name filter</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">7</span>
                    <strong>Publica a email-transaction topic</strong>
                    <p>TransactionParsedEvent con amount, merchant, category, date, transactionType</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">8</span>
                    <strong>pilasfi-quarkus persiste transaccion</strong>
                    <p>Verifica duplicados por emailMessageId, guarda Transaction en PostgreSQL</p>
                </div>
                <div class="flow-arrow">↓</div>

                <div class="flow-step">
                    <span class="flow-step-number">9</span>
                    <strong>App muestra transacciones</strong>
                    <p>GET /api/transactions, lista actualizada en UI con pull-to-refresh</p>
                </div>
            </section>

            <!-- PARSER FLOW SECTION -->
            <section id="parser-flow" class="section">
                <h2 class="section-title">Flujo Detallado: Pipeline de Parsing</h2>

                <div class="diagram">
                      EMAIL ENTRANTE
                            │
                            ▼
              ┌─────────────────────────┐
              │  1. BLACKLIST CHECK     │
              │  ─────────────────────  │
              │  sender_blacklist table │
              │  Si match → DESCARTAR   │
              └─────────────────────────┘
                            │
                            ▼
              ┌─────────────────────────┐
              │  2. REGEX DB PARSERS    │
              │  ─────────────────────  │
              │  transaction_parsers    │
              │  Ordenados por priority │
              │  Match sender + subject │
              │  Extrae: amount,        │
              │  merchant, date         │
              └─────────────────────────┘
                            │
              ┌─────────────┴─────────────┐
              │                           │
        MATCH FOUND               NO MATCH
              │                           │
              ▼                           ▼
     ┌─────────────────┐    ┌─────────────────────────┐
     │ Continua a      │    │  3. DISCARD PARSERS     │
     │ Category Parser │    │  ─────────────────────  │
     └─────────────────┘    │  discard_parsers table  │
                            │  Detecta: marketing,    │
                            │  OTP, alertas, promos   │
                            └─────────────────────────┘
                                          │
                            ┌─────────────┴─────────────┐
                            │                           │
                      IS DISCARDABLE           NOT DISCARDABLE
                            │                           │
                            ▼                           ▼
                     ┌───────────┐      ┌─────────────────────────┐
                     │ DESCARTAR │      │  4. AI FALLBACK         │
                     │ (log it)  │      │  ─────────────────────  │
                     └───────────┘      │  OpenAI GPT-4o-mini OR  │
                                        │  Google Gemini          │
                                        │  Prompt estructurado    │
                                        │  Extrae: amount,        │
                                        │  merchant, date, type   │
                                        └─────────────────────────┘
                                                      │
                                                      ▼
                                        ┌─────────────────────────┐
                                        │  5. CATEGORY PARSER     │
                                        │  ─────────────────────  │
                                        │  category_parsers table │
                                        │  Mapea merchant →       │
                                        │  categoria predefinida  │
                                        └─────────────────────────┘
                                                      │
                                                      ▼
                                        ┌─────────────────────────┐
                                        │  6. DISPLAY NAME FILTER │
                                        │  ─────────────────────  │
                                        │  Compara merchant con   │
                                        │  user.displayName       │
                                        │  Si match → DESCARTAR   │
                                        │  (transferencia propia) │
                                        └─────────────────────────┘
                                                      │
                                                      ▼
                                        ┌─────────────────────────┐
                                        │  PUBLICAR TRANSACCION   │
                                        │  → email-transaction    │
                                        └─────────────────────────┘
                </div>

                <h3>Ejemplos de Parsers en Base de Datos</h3>
                <div class="collapsible open">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Transaction Parsers (Regex)</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <table>
                            <tr>
                                <th>Bank</th>
                                <th>Sender Pattern</th>
                                <th>Amount Regex</th>
                                <th>Merchant Regex</th>
                            </tr>
                            <tr>
                                <td>BCP</td>
                                <td><code>notificaciones@bcp\.com\.pe</code></td>
                                <td><code>S/\s*([\d,]+\.\d{2})</code></td>
                                <td><code>en\s+(.+?)\s+el</code></td>
                            </tr>
                            <tr>
                                <td>BBVA</td>
                                <td><code>alertas@bbva\.pe</code></td>
                                <td><code>por\s+S/\s*([\d,]+\.\d{2})</code></td>
                                <td><code>comercio:\s*(.+)</code></td>
                            </tr>
                            <tr>
                                <td>Interbank</td>
                                <td><code>avisos@interbank\.pe</code></td>
                                <td><code>monto:\s*S/\s*([\d,]+\.\d{2})</code></td>
                                <td><code>establecimiento:\s*(.+)</code></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Discard Parsers</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <table>
                            <tr>
                                <th>Name</th>
                                <th>Sender Pattern</th>
                                <th>Subject Pattern</th>
                                <th>Reason</th>
                            </tr>
                            <tr>
                                <td>BCP Marketing</td>
                                <td><code>marketing@bcp\.com\.pe</code></td>
                                <td><code>.*</code></td>
                                <td>Marketing email</td>
                            </tr>
                            <tr>
                                <td>OTP Alerts</td>
                                <td><code>.*@.*bank.*</code></td>
                                <td><code>codigo.*seguridad|OTP|verificacion</code></td>
                                <td>Security OTP</td>
                            </tr>
                            <tr>
                                <td>Balance Alerts</td>
                                <td><code>alertas@.*</code></td>
                                <td><code>saldo.*cuenta|balance</code></td>
                                <td>Balance notification</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <h3>Category Parsers</h3>
                        <span class="collapsible-toggle">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <table>
                            <tr>
                                <th>Merchant Pattern</th>
                                <th>Category</th>
                            </tr>
                            <tr>
                                <td><code>UBER.*|DIDI.*|CABIFY.*|BEAT.*</code></td>
                                <td>Transporte</td>
                            </tr>
                            <tr>
                                <td><code>WONG|METRO|PLAZA VEA|TOTTUS|VIVANDA</code></td>
                                <td>Supermercado</td>
                            </tr>
                            <tr>
                                <td><code>RAPPI|PEDIDOS YA|GLOVO</code></td>
                                <td>Delivery</td>
                            </tr>
                            <tr>
                                <td><code>NETFLIX|SPOTIFY|DISNEY|HBO|PRIME</code></td>
                                <td>Entretenimiento</td>
                            </tr>
                            <tr>
                                <td><code>CLARO|MOVISTAR|ENTEL|BITEL</code></td>
                                <td>Telefonia</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </section>

            <!-- OAUTH FLOW SECTION -->
            <section id="oauth-flow" class="section">
                <h2 class="section-title">Flujo OAuth Detallado</h2>

                <h3>Google OAuth (Gmail)</h3>
                <div class="diagram">
┌─────────────┐     ┌─────────────────┐     ┌──────────────────┐
│ Flutter App │     │ pilasfi-quarkus │     │ Google OAuth     │
└──────┬──────┘     └────────┬────────┘     └────────┬─────────┘
       │                     │                       │
       │  1. User taps       │                       │
       │  "Connect Gmail"    │                       │
       │─────────────────────│                       │
       │                     │                       │
       │  2. Open browser ───│───────────────────────│───────────▶
       │     with OAuth URL  │                       │
       │     scope: gmail.readonly                   │
       │                     │                       │
       │◀────────────────────│───────────────────────│────────────
       │  3. User authorizes │                       │
       │     Redirect with   │                       │
       │     auth_code       │                       │
       │                     │                       │
       │  4. POST /api/email-config                  │
       │     {authCode, provider: "GMAIL"}           │
       │────────────────────▶│                       │
       │                     │                       │
       │                     │  5. Exchange code     │
       │                     │     for tokens        │
       │                     │──────────────────────▶│
       │                     │                       │
       │                     │◀──────────────────────│
       │                     │  6. access_token,     │
       │                     │     refresh_token,    │
       │                     │     expires_in        │
       │                     │                       │
       │                     │  7. Save EmailConfig  │
       │                     │     Publish event     │
       │                     │                       │
       │◀────────────────────│                       │
       │  8. 200 OK          │                       │
       │                     │                       │
                </div>

                <h3>Microsoft OAuth (Outlook)</h3>
                <div class="diagram">
┌─────────────┐     ┌─────────────────┐     ┌──────────────────┐
│ Flutter App │     │ pilasfi-quarkus │     │ Azure AD         │
└──────┬──────┘     └────────┬────────┘     └────────┬─────────┘
       │                     │                       │
       │  1. User taps       │                       │
       │  "Connect Outlook"  │                       │
       │─────────────────────│                       │
       │                     │                       │
       │  2. Open browser ───│───────────────────────│───────────▶
       │     Azure AD login  │                       │
       │     scope: Mail.Read offline_access         │
       │                     │                       │
       │◀────────────────────│───────────────────────│────────────
       │  3. User authorizes │                       │
       │     Redirect with   │                       │
       │     auth_code       │                       │
       │                     │                       │
       │  4. POST /api/email-config                  │
       │     {authCode, provider: "OUTLOOK"}         │
       │────────────────────▶│                       │
       │                     │                       │
       │                     │  5. POST /oauth2/v2.0/token
       │                     │──────────────────────▶│
       │                     │                       │
       │                     │◀──────────────────────│
       │                     │  6. tokens response   │
       │                     │                       │
       │                     │  7. Save & publish    │
       │                     │                       │
       │◀────────────────────│                       │
       │  8. 200 OK          │                       │
                </div>
            </section>

            <!-- TOKEN REFRESH SECTION -->
            <section id="token-refresh" class="section">
                <h2 class="section-title">Token Refresh Flow</h2>

                <div class="alert alert-warning">
                    <strong>Importante:</strong> Los tokens de acceso expiran (Gmail: 1 hora, Outlook: 1 hora).
                    El sistema refresca automaticamente antes de la expiracion.
                </div>

                <div class="diagram">
┌─────────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│ pilasfi-email-sync  │     │ OAuth Provider  │     │ pilasfi-quarkus  │
└──────────┬──────────┘     └────────┬────────┘     └────────┬─────────┘
           │                         │                       │
           │  Scheduler runs         │                       │
           │  every 5 minutes        │                       │
           │                         │                       │
           │  1. Check tokens        │                       │
           │     expiring in < 5min  │                       │
           │                         │                       │
           │  2. POST refresh_token  │                       │
           │────────────────────────▶│                       │
           │                         │                       │
           │◀────────────────────────│                       │
           │  3. New access_token    │                       │
           │     + refresh_token     │                       │
           │                         │                       │
           │  4. Publish TokenRefreshedEvent                 │
           │     to token-refreshed topic                    │
           │─────────────────────────│──────────────────────▶│
           │                         │                       │
           │                         │  5. Update EmailConfig│
           │                         │     with new tokens   │
           │                         │                       │
           │                         │  6. Persist to DB     │
           │                         │                       │
                </div>

                <h3>TokenRefreshedEvent Schema</h3>
<pre><code>{
  "userId": "uuid",
  "provider": "GMAIL" | "OUTLOOK",
  "accessToken": "new_access_token",
  "refreshToken": "new_refresh_token",  // May be same or new
  "expiresAt": "2026-01-23T15:30:00Z",
  "refreshedAt": "2026-01-23T14:30:00Z"
}</code></pre>
            </section>

            <!-- FOOTER -->
            <footer style="margin-top: 60px; padding-top: 30px; border-top: 1px solid var(--border-color); color: var(--text-muted); font-size: 12px;">
                <p>PilasFi Platform - Documentacion Tecnica v3.0</p>
                <p>Actualizado: 2026-01-23</p>
                <p>Generado automaticamente basado en analisis de codigo fuente</p>
                <p>Branches analizados:</p>
                <ul style="margin-top: 10px;">
                    <li>pilasfi-quarkus: feat/new-backend-architecture</li>
                    <li>pilasfi-parser-service: feature/newarch</li>
                    <li>pilasfi-email-sync: feature/fixandres</li>
                    <li>app-pilas-fe: main</li>
                    <li>pilasfi-infra-gcp: feature/init</li>
                    <li>pilasfi-infra-apps: feature/new</li>
                </ul>
            </footer>
        </main>
    </div>

    <script>
        // ========================================
        // PilasFi Documentation - Interactive JS
        // Inspired by Stripe, Zelle, MetaMask
        // ========================================

        // DOM Elements
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.querySelector('.sidebar-overlay');
        const backToTopBtn = document.querySelector('.back-to-top');
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');

        // ========================================
        // Mobile Menu Toggle with Animation
        // ========================================
        function openMobileMenu() {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('active');
            mobileMenuToggle.setAttribute('aria-expanded', 'true');
            mobileMenuToggle.innerHTML = '&#10005;';
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
            mobileMenuToggle.setAttribute('aria-expanded', 'false');
            mobileMenuToggle.innerHTML = '&#9776;';
            document.body.style.overflow = '';
        }

        mobileMenuToggle.addEventListener('click', () => {
            sidebar.classList.contains('open') ? closeMobileMenu() : openMobileMenu();
        });

        sidebarOverlay.addEventListener('click', closeMobileMenu);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                closeMobileMenu();
            }
        });

        // ========================================
        // Back to Top Button
        // ========================================
        let scrollTicking = false;

        function handleScroll() {
            if (!scrollTicking) {
                window.requestAnimationFrame(() => {
                    toggleBackToTop();
                    updateActiveNavLink();
                    scrollTicking = false;
                });
                scrollTicking = true;
            }
        }

        function toggleBackToTop() {
            if (window.scrollY > 500) {
                backToTopBtn.classList.add('visible');
            } else {
                backToTopBtn.classList.remove('visible');
            }
        }

        window.addEventListener('scroll', handleScroll, { passive: true });

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // ========================================
        // Active Navigation Highlighting
        // ========================================
        function updateActiveNavLink() {
            const scrollPosition = window.scrollY + 120;

            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.offsetHeight;
                const sectionId = section.getAttribute('id');

                if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
                    navLinks.forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('href') === `#${sectionId}`) {
                            link.classList.add('active');
                        }
                    });
                }
            });
        }

        // Add active state styling dynamically
        const activeStyle = document.createElement('style');
        activeStyle.textContent = `
            .nav-link.active {
                background: rgba(109, 30, 212, 0.15);
                color: #FFFFFF;
            }
            .nav-link.active::before {
                transform: scaleY(1);
            }
        `;
        document.head.appendChild(activeStyle);

        // ========================================
        // Collapsible Sections
        // ========================================
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.setAttribute('tabindex', '0');
            header.setAttribute('role', 'button');

            header.addEventListener('click', () => {
                header.parentElement.classList.toggle('open');
            });

            header.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    header.parentElement.classList.toggle('open');
                }
            });
        });

        // ========================================
        // Smooth Scroll Navigation
        // ========================================
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                const target = document.getElementById(targetId);

                if (sidebar.classList.contains('open')) {
                    closeMobileMenu();
                }

                if (target) {
                    setTimeout(() => {
                        const yOffset = -80;
                        const y = target.getBoundingClientRect().top + window.pageYOffset + yOffset;
                        window.scrollTo({ top: y, behavior: 'smooth' });
                    }, sidebar.classList.contains('open') ? 300 : 0);
                }
            });
        });

        // ========================================
        // Table Wrapper for Responsive Tables
        // ========================================
        document.querySelectorAll('table').forEach(table => {
            if (!table.parentElement.classList.contains('table-wrapper')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            }
        });

        // ========================================
        // Intersection Observer for Animations
        // ========================================
        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1
        };

        const sectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Prepare sections for animation
        sections.forEach((section, index) => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(30px)';
            section.style.transition = `opacity 0.6s ease ${index * 0.1}s, transform 0.6s ease ${index * 0.1}s`;
            sectionObserver.observe(section);
        });

        // ========================================
        // Resize Handler
        // ========================================
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (window.innerWidth > 1024) {
                    closeMobileMenu();
                }
            }, 100);
        });

        // ========================================
        // Subtle Parallax on Gradient Background
        // ========================================
        const gradientBg = document.querySelector('.gradient-bg');

        if (gradientBg && window.innerWidth > 768) {
            let ticking = false;

            document.addEventListener('mousemove', (e) => {
                if (!ticking) {
                    window.requestAnimationFrame(() => {
                        const x = (e.clientX / window.innerWidth - 0.5) * 20;
                        const y = (e.clientY / window.innerHeight - 0.5) * 20;
                        gradientBg.style.transform = `translate(${x}px, ${y}px)`;
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        }

        // ========================================
        // Initial Load Animation
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.add('loaded');
            updateActiveNavLink();
        });
    </script>
</body>
</html>
