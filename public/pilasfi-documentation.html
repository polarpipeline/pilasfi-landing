<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PilasFi - Documentacion Tecnica API</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --accent-purple: #8b5cf6;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #2a2a3a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }
        header { background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%); border-bottom: 1px solid var(--border); padding: 16px 0; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); }
        .header-content { display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 24px; font-weight: 700; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; }
        .version-badge { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .docs-layout { display: grid; grid-template-columns: 260px 1fr; gap: 40px; padding: 40px 0; }
        .sidebar { position: sticky; top: 80px; height: calc(100vh - 120px); overflow-y: auto; padding-right: 16px; }
        .sidebar-section { margin-bottom: 24px; }
        .sidebar-title { font-size: 11px; font-weight: 700; color: var(--accent-light); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; padding-left: 12px; }
        .sidebar-link { display: block; padding: 8px 12px; color: var(--text-secondary); text-decoration: none; border-radius: 6px; font-size: 13px; transition: all 0.2s; border-left: 2px solid transparent; }
        .sidebar-link:hover { background: var(--bg-tertiary); color: var(--text-primary); border-left-color: var(--accent); }
        .main-content { min-width: 0; }
        section { margin-bottom: 48px; }
        h1 { font-size: 38px; font-weight: 800; margin-bottom: 12px; background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-light) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { font-size: 26px; font-weight: 700; margin-bottom: 16px; padding-top: 24px; color: var(--text-primary); }
        h3 { font-size: 18px; font-weight: 600; margin-bottom: 10px; margin-top: 24px; color: var(--text-primary); }
        h4 { font-size: 14px; font-weight: 600; margin-bottom: 6px; margin-top: 16px; color: var(--accent-light); }
        p { color: var(--text-secondary); margin-bottom: 14px; font-size: 14px; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
        .feature-card { background: linear-gradient(145deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: all 0.3s ease; }
        .feature-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .feature-icon { font-size: 32px; margin-bottom: 12px; }
        .feature-card h4 { color: var(--text-primary); font-size: 15px; margin-top: 0; margin-bottom: 6px; }
        .feature-card p { font-size: 13px; margin-bottom: 0; }
        pre { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; padding: 16px; overflow-x: auto; margin-bottom: 14px; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent-light); }
        pre code { color: #e2e8f0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-primary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { color: var(--text-secondary); }
        .endpoint { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .endpoint-header { display: flex; align-items: center; gap: 12px; padding: 14px 20px; background: linear-gradient(90deg, var(--bg-tertiary) 0%, transparent 100%); border-bottom: 1px solid var(--border); }
        .method { padding: 5px 12px; border-radius: 5px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .method-get { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .method-post { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .method-put { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .method-delete { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .endpoint-path { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-primary); }
        .endpoint-body { padding: 20px; }
        .endpoint-description { color: var(--text-secondary); margin-bottom: 16px; font-size: 14px; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .badge-required { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .badge-optional { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
        ul, ol { margin-bottom: 14px; padding-left: 20px; }
        li { color: var(--text-secondary); margin-bottom: 8px; font-size: 14px; }
        .diagram { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.4; overflow-x: auto; white-space: pre; color: var(--text-secondary); }
        .alert { padding: 14px 18px; border-radius: 10px; margin-bottom: 16px; display: flex; align-items: flex-start; gap: 12px; }
        .alert-info { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); }
        .alert-warning { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); }
        .alert span { font-size: 18px; }
        .service-card { background: linear-gradient(145deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .service-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
        .service-name { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .service-port { background: var(--bg-primary); padding: 5px 12px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--accent-light); border: 1px solid var(--border); }
        .flow-step { display: flex; align-items: flex-start; gap: 14px; margin-bottom: 18px; }
        .flow-number { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0; }
        .flow-content { flex: 1; padding-top: 2px; }
        .flow-content h4 { margin-top: 0; color: var(--text-primary); }
        .tech-stack { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .tech-badge { background: var(--bg-primary); border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; font-size: 12px; color: var(--text-secondary); transition: all 0.2s; }
        .tech-badge:hover { border-color: var(--accent); color: var(--accent-light); }
        @media (max-width: 1024px) { .docs-layout { grid-template-columns: 1fr; } .sidebar { position: static; height: auto; display: none; } h1 { font-size: 28px; } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .gradient-orb { position: fixed; width: 500px; height: 500px; border-radius: 50%; filter: blur(100px); opacity: 0.12; pointer-events: none; z-index: -1; }
        .gradient-orb-1 { top: -150px; right: -150px; background: var(--accent); }
        .gradient-orb-2 { bottom: -150px; left: -150px; background: var(--accent-purple); }
    </style>
</head>
<body>
    <div class="gradient-orb gradient-orb-1"></div>
    <div class="gradient-orb gradient-orb-2"></div>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="https://pilasfi.com" class="logo">PilasFi</a>
                <span class="version-badge">API v1.0 - Enero 2025</span>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="docs-layout">
            <aside class="sidebar">
                <nav>
                    <div class="sidebar-section">
                        <div class="sidebar-title">Inicio</div>
                        <a href="#overview" class="sidebar-link">Vision General</a>
                        <a href="#features" class="sidebar-link">Caracteristicas</a>
                        <a href="#tech-stack" class="sidebar-link">Stack Tecnologico</a>
                    </div>
                    <div class="sidebar-section">
                        <div class="sidebar-title">Arquitectura</div>
                        <a href="#architecture" class="sidebar-link">Sistema Distribuido</a>
                        <a href="#microservices" class="sidebar-link">Microservicios</a>
                        <a href="#events" class="sidebar-link">Eventos Pub/Sub</a>
                        <a href="#parsing-flow" class="sidebar-link">Flujo de Parseo</a>
                    </div>
                    <div class="sidebar-section">
                        <div class="sidebar-title">API Reference</div>
                        <a href="#auth" class="sidebar-link">Autenticacion</a>
                        <a href="#email-config" class="sidebar-link">Email Config</a>
                        <a href="#transactions" class="sidebar-link">Transacciones</a>
                        <a href="#alerts" class="sidebar-link">Alertas</a>
                        <a href="#webhooks" class="sidebar-link">Webhooks</a>
                        <a href="#analytics" class="sidebar-link">Analytics</a>
                    </div>
                    <div class="sidebar-section">
                        <div class="sidebar-title">Modelos</div>
                        <a href="#models" class="sidebar-link">Base de Datos</a>
                        <a href="#parsers-db" class="sidebar-link">Parser Database</a>
                    </div>
                    <div class="sidebar-section">
                        <div class="sidebar-title">Avanzado</div>
                        <a href="#ai-parsing" class="sidebar-link">AI Parsing</a>
                        <a href="#banks" class="sidebar-link">Bancos Soportados</a>
                        <a href="#security" class="sidebar-link">Seguridad</a>
                    </div>
                </nav>
            </aside>
            <main class="main-content">
                <section id="overview">
                    <h1>PilasFi - Documentacion Tecnica</h1>
                    <p style="font-size: 16px; color: var(--text-primary); margin-bottom: 28px;">Sistema distribuido de finanzas personales con extraccion automatica de transacciones mediante IA.</p>
                    <div class="card">
                        <h3>Que es PilasFi?</h3>
                        <p>PilasFi es una plataforma que automatiza el registro de gastos procesando emails bancarios ecuatorianos. Utiliza una arquitectura de microservicios event-driven con Quarkus, Google Cloud Pub/Sub e IA (OpenAI GPT-4o / Google Gemini) para extraer y categorizar transacciones automaticamente.</p>
                    </div>
                    <div class="alert alert-info">
                        <span>&#8505;</span>
                        <div><strong>Base URL:</strong> <code>https://api.pilasfi.com/api/v1</code></div>
                    </div>
                </section>
                <section id="features">
                    <h2>Caracteristicas Principales</h2>
                    <div class="card-grid">
                        <div class="feature-card"><div class="feature-icon">&#129302;</div><h4>IA Dual: OpenAI + Gemini</h4><p>GPT-4o-mini y Gemini-3-Flash con Extended Thinking para decisiones criticas.</p></div>
                        <div class="feature-card"><div class="feature-icon">&#128231;</div><h4>Gmail + Outlook</h4><p>OAuth2 con refresh automatico de tokens y webhooks en tiempo real.</p></div>
                        <div class="feature-card"><div class="feature-icon">&#127974;</div><h4>7+ Bancos Ecuador</h4><p>Pichincha, Produbanco, Guayaquil, Diners, PacifiCard, Deuna, Titanium.</p></div>
                        <div class="feature-card"><div class="feature-icon">&#9889;</div><h4>Auto-Discovery</h4><p>IA genera parsers regex automaticamente con 90%+ de confianza.</p></div>
                        <div class="feature-card"><div class="feature-icon">&#128276;</div><h4>Alertas Inteligentes</h4><p>Notificaciones push por categoria, umbral de gasto o presupuesto.</p></div>
                        <div class="feature-card"><div class="feature-icon">&#128202;</div><h4>Analytics en Tiempo Real</h4><p>Dashboard con gastos por categoria, tendencias y proyecciones.</p></div>
                    </div>
                </section>
                <section id="tech-stack">
                    <h2>Stack Tecnologico</h2>
                    <div class="card">
                        <h4>Backend</h4>
                        <div class="tech-stack"><span class="tech-badge">Java 17+ (Runtime 21)</span><span class="tech-badge">Quarkus 3.30.5</span><span class="tech-badge">Hibernate Panache</span><span class="tech-badge">Flyway</span></div>
                        <h4>Base de Datos</h4>
                        <div class="tech-stack"><span class="tech-badge">PostgreSQL 16 (Cloud SQL)</span><span class="tech-badge">Redis (Cache)</span></div>
                        <h4>Mensajeria</h4>
                        <div class="tech-stack"><span class="tech-badge">Google Cloud Pub/Sub</span><span class="tech-badge">Webhooks Push</span></div>
                        <h4>IA</h4>
                        <div class="tech-stack"><span class="tech-badge">OpenAI GPT-4o-mini</span><span class="tech-badge">Google Gemini 3 Flash</span><span class="tech-badge">Extended Thinking</span></div>
                        <h4>Infraestructura</h4>
                        <div class="tech-stack"><span class="tech-badge">Google Cloud Run</span><span class="tech-badge">Cloud Scheduler</span><span class="tech-badge">Firebase Auth</span><span class="tech-badge">FCM Push</span></div>
                    </div>
                </section>
                <section id="architecture">
                    <h2>Arquitectura del Sistema</h2>
                    <p>Arquitectura Hexagonal (Ports and Adapters) con microservicios event-driven.</p>
                    <div class="diagram">+------------------------------------------------------------------+
|                         CLIENTES                                 |
|   App Flutter (iOS/Android)    +    Frontend Web                 |
+--------------------------------+---------------------------------+
                                 |
                         +-------v--------+
                         |  pilasfi-api   |  REST API + Webhooks
                         |   (Quarkus)    |  Port: 8080
                         +-------+--------+
                                 |
             +-------------------+-------------------+
             |                   |                   |
             v                   v                   v
       PostgreSQL            Redis           Firebase Auth
       (Cloud SQL)          (Cache)          (JWT Tokens)
             |                   |                   |
             +-------------------+-------------------+
                                 |
             +-------------------v-------------------+
             |        GOOGLE CLOUD PUB/SUB          |
             |                                       |
             |  Topics:                              |
             |  - user-email-config                  |
             |  - sync-email-request                 |
             |  - email-raw                          |
             |  - email-transaction                  |
             |  - token-refreshed                    |
             +-------------------+-------------------+
                                 |
     +-----------+---------------+---------------+-----------+
     |           |               |               |           |
     v           v               v               v           v
 email-sync  parser-svc   sync-scheduler   Gmail API   Outlook API
  :8081       :8082          :8083         (OAuth2)    (OAuth2)</div>
                </section>
                <section id="microservices">
                    <h2>Microservicios</h2>
                    <div class="service-card">
                        <div class="service-header"><span class="service-name">pilasfi-api</span><span class="service-port">Port: 8080</span></div>
                        <p>Core de negocio: usuarios, transacciones, presupuestos, alertas, autenticacion Firebase.</p>
                        <h4>Endpoints Principales:</h4>
                        <ul>
                            <li><code>POST /api/v1/auth/firebase</code> - Login con Firebase Token</li>
                            <li><code>GET/POST/PUT/DELETE /api/v1/email-config</code> - Gestion de emails</li>
                            <li><code>GET/POST /api/v1/transactions</code> - Transacciones</li>
                            <li><code>GET/POST/PUT/DELETE /api/v1/alerts</code> - Alertas de gasto</li>
                            <li><code>POST /api/v1/webhook/gmail/notify</code> - Push de Gmail</li>
                            <li><code>POST /api/v1/webhook/outlook/notify</code> - Webhook Outlook</li>
                            <li><code>GET /api/v1/analytics/dashboard</code> - Dashboard</li>
                        </ul>
                    </div>
                    <div class="service-card">
                        <div class="service-header"><span class="service-name">pilasfi-email-sync</span><span class="service-port">Port: 8081</span></div>
                        <p>Sincronizacion de emails via OAuth (Gmail/Outlook), gestion de tokens, filtrado de dominios.</p>
                        <h4>Responsabilidades:</h4>
                        <ul>
                            <li>Consume <code>EmailConfigUpdatedEvent</code> y <code>SyncRequestEvent</code></li>
                            <li>Conecta a Gmail API / Microsoft Graph</li>
                            <li>Filtra dominios personales (gmail.com, yahoo.com, etc.)</li>
                            <li>Publica <code>EmailRawReceivedEvent</code> a topic email-raw</li>
                            <li>Refresh automatico de OAuth tokens</li>
                        </ul>
                    </div>
                    <div class="service-card">
                        <div class="service-header"><span class="service-name">pilasfi-parser-service</span><span class="service-port">Port: 8082</span></div>
                        <p>Procesamiento inteligente de emails con IA dual (OpenAI/Gemini) y parsers regex auto-generados.</p>
                        <h4>Pipeline de Parseo:</h4>
                        <ol>
                            <li>Deduplication Check</li>
                            <li>Domain Blacklist Check</li>
                            <li>Display Name Filter (evita transferencias personales)</li>
                            <li>Discard Parsers (OTP, seguridad, marketing)</li>
                            <li>Database Regex Parsers (FAST PATH)</li>
                            <li>AI Parser con Gemini/OpenAI (FALLBACK)</li>
                            <li>Validacion NOT_FINANCIAL_ENTITY (Extended Thinking)</li>
                        </ol>
                        <h4>AI Providers:</h4>
                        <div class="tech-stack"><span class="tech-badge">gemini-3-flash-preview</span><span class="tech-badge">gpt-4o-mini</span><span class="tech-badge">Extended Thinking: LOW/MEDIUM/HIGH</span></div>
                    </div>
                    <div class="service-card">
                        <div class="service-header"><span class="service-name">pilasfi-sync-scheduler</span><span class="service-port">Port: 8083</span></div>
                        <p>Scheduler distribuido que orquesta syncs periodicos cada 5 minutos via Cloud Scheduler.</p>
                        <h4>Endpoints:</h4>
                        <ul>
                            <li><code>POST /scheduler/trigger-sync</code> - Trigger general (Cloud Scheduler)</li>
                            <li><code>POST /scheduler/trigger-sync/{configId}</code> - Trigger manual</li>
                            <li><code>GET /scheduler/status</code> - Estado del scheduler</li>
                        </ul>
                    </div>
                </section>
                <section id="events">
                    <h2>Eventos Pub/Sub</h2>
                    <div class="card">
                        <table>
                            <thead><tr><th>Topic</th><th>Publisher</th><th>Consumer</th><th>Descripcion</th></tr></thead>
                            <tbody>
                                <tr><td><code>user-email-config</code></td><td>pilasfi-api</td><td>email-sync</td><td>Config de email creada/actualizada</td></tr>
                                <tr><td><code>sync-email-request</code></td><td>sync-scheduler</td><td>email-sync</td><td>Trigger de sincronizacion</td></tr>
                                <tr><td><code>email-raw</code></td><td>email-sync</td><td>parser-service</td><td>Email crudo para parsear</td></tr>
                                <tr><td><code>email-transaction</code></td><td>parser-service</td><td>pilasfi-api</td><td>Transaccion parseada</td></tr>
                                <tr><td><code>token-refreshed</code></td><td>email-sync</td><td>pilasfi-api</td><td>Token OAuth renovado</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <h3>EmailRawReceivedEvent</h3>
                    <pre><code>{
  "userId": "user-123",
  "emailId": "19d25a8e50...",
  "senderEmail": "notificaciones@pichincha.com",
  "senderDomain": "pichincha.com",
  "subject": "Compra aprobada: $50.00 USD",
  "bodyHtml": "&lt;html&gt;...&lt;/html&gt;",
  "emailDate": "2025-01-24T10:30:00Z",
  "userDisplayName": "Juan Perez",
  "provider": "gmail"
}</code></pre>
                    <h3>TransactionParsedEvent</h3>
                    <pre><code>{
  "eventId": "uuid",
  "userId": "user-123",
  "sourceEmailId": "19d25a8e50...",
  "parserUsed": "ai-generated|regex|manual",
  "amount": 50.00,
  "currency": "USD",
  "merchant": "SUPERMAXI",
  "transactionDate": "2025-01-24T10:30:00Z",
  "transactionType": "DEBIT|CREDIT|TRANSFER_IN|TRANSFER_OUT|PAYMENT",
  "cardLast4": "1234",
  "bankName": "Banco Pichincha",
  "confidence": 0.95,
  "categoryId": 1,
  "categorySlug": "food"
}</code></pre>
                </section>
                <section id="parsing-flow">
                    <h2>Flujo de Parseo (Critico)</h2>
                    <div class="flow-step"><div class="flow-number">1</div><div class="flow-content"><h4>Deduplication</h4><p>Verifica si el email ya fue procesado. Si existe, skip.</p></div></div>
                    <div class="flow-step"><div class="flow-number">2</div><div class="flow-content"><h4>Domain Blacklist</h4><p>Consulta <code>domain_blacklist</code>. Si el dominio esta (ej: netflix.com), skip sin usar IA.</p></div></div>
                    <div class="flow-step"><div class="flow-number">3</div><div class="flow-content"><h4>Display Name Filter</h4><p>Si el merchant == display name del usuario, es transferencia personal. Skip.</p></div></div>
                    <div class="flow-step"><div class="flow-number">4</div><div class="flow-content"><h4>Discard Parsers</h4><p>Consulta <code>discard_parsers</code> para emails no-transaccionales: OTP, SECURITY, MARKETING, CREDIT_CARD_PAYMENT.</p></div></div>
                    <div class="flow-step"><div class="flow-number">5</div><div class="flow-content"><h4>Regex Parsers (Fast Path)</h4><p>Consulta <code>email_parsers</code>. Si hay match con regex guardado, extrae datos y publica transaccion.</p></div></div>
                    <div class="flow-step"><div class="flow-number">6</div><div class="flow-content"><h4>AI Parser (Fallback)</h4><p>Llama a Gemini/OpenAI. Si confidence >= 90%, guarda nuevo parser regex. Si >= 50%, publica transaccion.</p></div></div>
                    <div class="flow-step"><div class="flow-number">7</div><div class="flow-content"><h4>Validacion NOT_FINANCIAL_ENTITY</h4><p>Si IA dice "no es entidad financiera", segunda pasada con Extended Thinking HIGH. Confirma antes de blacklistear dominio (irreversible).</p></div></div>
                    <div class="alert alert-warning"><span>&#9888;</span><div><strong>Blacklisting es IRREVERSIBLE.</strong> Si se blacklistea un banco por error, el usuario pierde TODAS las transacciones de ese banco para siempre. Por eso usamos Extended Thinking HIGH para validar.</div></div>
                </section>
                <section id="auth">
                    <h2>Autenticacion</h2>
                    <div class="alert alert-info"><span>&#128274;</span><div>Todos los endpoints requieren Firebase JWT en header <code>Authorization: Bearer {token}</code></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/auth/firebase</span></div><div class="endpoint-body"><p class="endpoint-description">Login o registro con Firebase ID Token</p><h4>Request</h4><pre><code>{ "idToken": "eyJhbGciOiJSUzI1NiIs..." }</code></pre><h4>Response</h4><pre><code>{
  "user": {
    "id": 123,
    "uid": "firebase-uid",
    "email": "user@example.com",
    "displayName": "Juan Perez",
    "onboardingCompleted": true
  },
  "isNewUser": false
}</code></pre></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-get">GET</span><span class="endpoint-path">/api/v1/auth/me</span></div><div class="endpoint-body"><p class="endpoint-description">Obtener perfil del usuario autenticado</p></div></div>
                </section>
                <section id="email-config">
                    <h2>Email Config</h2>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-get">GET</span><span class="endpoint-path">/api/v1/email-config</span></div><div class="endpoint-body"><p class="endpoint-description">Listar todas las cuentas de email conectadas</p><h4>Response</h4><pre><code>[{
  "id": 1,
  "provider": "gmail",
  "email": "user@gmail.com",
  "syncEnabled": true,
  "lastSyncDate": "2025-01-24T10:30:00Z",
  "syncStatus": "IDLE"
}]</code></pre></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/email-config/{id}/sync</span></div><div class="endpoint-body"><p class="endpoint-description">Trigger manual de sincronizacion</p></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/email-config/{id}/enable</span></div><div class="endpoint-body"><p class="endpoint-description">Habilitar sincronizacion automatica</p></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/email-config/{id}/disable</span></div><div class="endpoint-body"><p class="endpoint-description">Deshabilitar sincronizacion automatica</p></div></div>
                </section>
                <section id="transactions">
                    <h2>Transacciones</h2>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-get">GET</span><span class="endpoint-path">/api/v1/transactions</span></div><div class="endpoint-body"><p class="endpoint-description">Listar transacciones con filtros</p><h4>Query Parameters</h4><table><tr><td><code>page</code></td><td>Numero de pagina</td><td><span class="badge badge-optional">Optional</span></td></tr><tr><td><code>size</code></td><td>Tamano de pagina</td><td><span class="badge badge-optional">Optional</span></td></tr><tr><td><code>categoryId</code></td><td>Filtrar por categoria</td><td><span class="badge badge-optional">Optional</span></td></tr><tr><td><code>type</code></td><td>DEBIT|CREDIT|TRANSFER_IN|TRANSFER_OUT|PAYMENT</td><td><span class="badge badge-optional">Optional</span></td></tr><tr><td><code>startDate</code></td><td>Fecha inicio (ISO 8601)</td><td><span class="badge badge-optional">Optional</span></td></tr><tr><td><code>endDate</code></td><td>Fecha fin (ISO 8601)</td><td><span class="badge badge-optional">Optional</span></td></tr></table><h4>Response</h4><pre><code>{
  "content": [{
    "id": 456,
    "amount": 25.50,
    "currency": "USD",
    "merchant": "SUPERMAXI",
    "transactionType": "DEBIT",
    "categorySlug": "food",
    "bankName": "Banco Pichincha",
    "cardLast4": "1234",
    "parserUsed": "regex",
    "parserConfidence": 0.95,
    "transactionDate": "2025-01-24T10:30:00Z"
  }],
  "totalElements": 150,
  "totalPages": 8
}</code></pre></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/transactions</span></div><div class="endpoint-body"><p class="endpoint-description">Crear transaccion manual</p><h4>Request</h4><pre><code>{
  "amount": 50.00,
  "currency": "USD",
  "merchant": "Restaurante XYZ",
  "transactionType": "DEBIT",
  "categoryId": 1,
  "transactionDate": "2025-01-24T12:00:00Z"
}</code></pre></div></div>
                </section>
                <section id="alerts">
                    <h2>Alertas</h2>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-get">GET</span><span class="endpoint-path">/api/v1/alerts</span></div><div class="endpoint-body"><p class="endpoint-description">Listar todas las alertas configuradas</p></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-get">GET</span><span class="endpoint-path">/api/v1/alerts/unread</span></div><div class="endpoint-body"><p class="endpoint-description">Alertas sin leer</p></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/alerts</span></div><div class="endpoint-body"><p class="endpoint-description">Crear nueva alerta</p><h4>Request</h4><pre><code>{
  "name": "Gasto alto en comida",
  "alertType": "spending_threshold",
  "conditionType": "ABOVE",
  "thresholdAmount": 500.00,
  "categoryId": 1
}</code></pre></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/alerts/{id}/read</span></div><div class="endpoint-body"><p class="endpoint-description">Marcar alerta como leida</p></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/alerts/read-all</span></div><div class="endpoint-body"><p class="endpoint-description">Marcar todas como leidas</p></div></div>
                </section>
                <section id="webhooks">
                    <h2>Webhooks</h2>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/webhook/gmail/notify</span></div><div class="endpoint-body"><p class="endpoint-description">Push notification desde Gmail via Google Pub/Sub. Trigger automatico cuando llega nuevo email.</p></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-post">POST</span><span class="endpoint-path">/api/v1/webhook/outlook/notify</span></div><div class="endpoint-body"><p class="endpoint-description">Webhook de Microsoft Graph. Se renueva automaticamente cada 6 horas.</p></div></div>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-get">GET</span><span class="endpoint-path">/api/v1/webhook/outlook/notify</span></div><div class="endpoint-body"><p class="endpoint-description">Validacion de webhook Outlook (Microsoft lo llama para verificar).</p></div></div>
                </section>
                <section id="analytics">
                    <h2>Analytics</h2>
                    <div class="endpoint"><div class="endpoint-header"><span class="method method-get">GET</span><span class="endpoint-path">/api/v1/analytics/dashboard</span></div><div class="endpoint-body"><p class="endpoint-description">Dashboard completo con metricas</p><h4>Response</h4><pre><code>{
  "balance": { "income": 3500.00, "expenses": 2150.75, "net": 1349.25 },
  "spendingByCategory": [
    {"categorySlug": "food", "amount": 450.00, "percentage": 20.9},
    {"categorySlug": "transport", "amount": 380.50, "percentage": 17.7}
  ],
  "topMerchants": [{"name": "SUPERMAXI", "amount": 280.00, "count": 8}],
  "trends": { "vsLastMonth": -12.5, "vsLastYear": 8.3 }
}</code></pre></div></div>
                </section>
                <section id="models">
                    <h2>Modelos de Base de Datos</h2>
                    <h3>users</h3>
                    <div class="card"><pre><code>id: BIGSERIAL PK
uid: VARCHAR(128) - Firebase UID
email: VARCHAR(255) UNIQUE
displayName: VARCHAR(255)
authProvider: email|google|microsoft
onboardingCompleted: BOOLEAN
primaryGoal: savings|spending_control|investment
notifyNewExpenses: BOOLEAN
notifyBudgetAlerts: BOOLEAN</code></pre></div>
                    <h3>transactions</h3>
                    <div class="card"><pre><code>id: BIGSERIAL PK
userId: BIGINT FK -> users
amount: DECIMAL(15,2)
currency: VARCHAR(3) - USD
merchant: VARCHAR(255)
transactionType: DEBIT|CREDIT|TRANSFER_IN|TRANSFER_OUT|PAYMENT
categoryId: BIGINT FK -> categories
emailSourceId: VARCHAR(500) - ID del email
bankName: VARCHAR(100)
cardLast4: VARCHAR(4)
parserUsed: regex|ai-generated|ai-one-time|manual
parserConfidence: DECIMAL(3,2)
transactionDate: TIMESTAMP</code></pre></div>
                    <h3>categories (14 predefinidas)</h3>
                    <div class="card"><table><thead><tr><th>ID</th><th>Slug</th><th>Tipo</th></tr></thead><tbody><tr><td>1</td><td>food</td><td>EXPENSE</td></tr><tr><td>2</td><td>transport</td><td>EXPENSE</td></tr><tr><td>3</td><td>housing</td><td>EXPENSE</td></tr><tr><td>4</td><td>utilities</td><td>EXPENSE</td></tr><tr><td>5</td><td>entertainment</td><td>EXPENSE</td></tr><tr><td>6</td><td>shopping</td><td>EXPENSE</td></tr><tr><td>7</td><td>health</td><td>EXPENSE</td></tr><tr><td>8</td><td>education</td><td>EXPENSE</td></tr><tr><td>9</td><td>subscriptions</td><td>EXPENSE</td></tr><tr><td>10</td><td>other_expense</td><td>EXPENSE</td></tr><tr><td>11</td><td>salary</td><td>INCOME</td></tr><tr><td>12</td><td>freelance</td><td>INCOME</td></tr><tr><td>13</td><td>investments</td><td>INCOME</td></tr><tr><td>14</td><td>other_income</td><td>INCOME</td></tr></tbody></table></div>
                </section>
                <section id="parsers-db">
                    <h2>Parser Database</h2>
                    <h3>email_parsers</h3>
                    <div class="card"><pre><code>id: UUID PK
fromEmailPattern: Regex del remitente
subjectRegex: Regex del subject
bodyRegex: Regex con grupos: (?&lt;merchant&gt;), (?&lt;amount&gt;)
staticFields: JSONB {bankName, transactionType}
confidence: DECIMAL 0.90+
timesUsed: INTEGER</code></pre></div>
                    <h3>domain_blacklist</h3>
                    <div class="card"><pre><code>id: BIGSERIAL PK
domain: VARCHAR UNIQUE (ej: netflix.com)
reason: NOT_FINANCIAL_ENTITY
// Una vez blacklisteados, emails se ignoran sin usar IA</code></pre></div>
                    <h3>discard_parsers</h3>
                    <div class="card"><pre><code>id: UUID PK
fromEmailPattern: Regex del remitente
discardCategory: OTP|SECURITY|MARKETING|CREDIT_CARD_PAYMENT|WALLET_TRANSFER
aiReasoning: TEXT
// Emails de bancos que NO son transacciones</code></pre></div>
                </section>
                <section id="ai-parsing">
                    <h2>AI Parsing</h2>
                    <div class="card">
                        <h4>Configuracion</h4>
                        <pre><code>pilasfi.ai.provider=gemini  # gemini o openai

# OpenAI
pilasfi.openai.model=gpt-4o-mini
pilasfi.openai.max-tokens=2000
pilasfi.openai.temperature=0.1

# Gemini
pilasfi.gemini.model=gemini-3-flash-preview
pilasfi.gemini.thinking-level=low  # low/medium/high

# Thresholds
parser.confidence.threshold.save=0.90  # Guardar parser
parser.confidence.threshold.use=0.50   # Publicar transaccion</code></pre>
                        <h4>Casos Especiales</h4>
                        <p><strong>1. Pagos a TC:</strong> is_transactional=false, discard_category=CREDIT_CARD_PAYMENT</p>
                        <p><strong>2. Transferencias personales:</strong> merchant == displayName -> Skip</p>
                        <p><strong>3. Recargas a wallets:</strong> discard_category=WALLET_TRANSFER</p>
                        <p><strong>4. Blacklisting:</strong> Extended Thinking HIGH para validar antes de blacklistear</p>
                    </div>
                </section>
                <section id="banks">
                    <h2>Bancos Soportados (Ecuador)</h2>
                    <div class="card"><table><thead><tr><th>Banco</th><th>Email Sender</th><th>Parser</th></tr></thead><tbody><tr><td>Banco Pichincha</td><td>notificaciones@pichincha.com</td><td>Regex &#9989;</td></tr><tr><td>Produbanco</td><td>notificaciones@produbanco.com</td><td>Regex &#9989;</td></tr><tr><td>Banco Guayaquil</td><td>alertas@bancoguayaquil.com</td><td>Regex &#9989;</td></tr><tr><td>Diners Club</td><td>servicioalcliente@dinersclub.com.ec</td><td>Regex &#9989;</td></tr><tr><td>Titanium</td><td>servicios@titanium.com.ec</td><td>Regex &#9989;</td></tr><tr><td>PacifiCard</td><td>notificaciones@infopacificard.com.ec</td><td>Regex &#9989;</td></tr><tr><td>Deuna</td><td>notificaciones@deunaapp.com</td><td>Regex &#9989;</td></tr><tr><td>Otros</td><td>*</td><td>AI &#129302;</td></tr></tbody></table></div>
                </section>
                <section id="security">
                    <h2>Seguridad</h2>
                    <div class="card">
                        <h4>Firebase Authentication</h4>
                        <p>JWT tokens verificados con Firebase Admin SDK. User ID en SecurityIdentity.</p>
                        <h4>OAuth2 (Gmail/Outlook)</h4>
                        <p>Tokens encriptados. Refresh automatico. Scopes: gmail.readonly, Mail.Read</p>
                        <h4>Pub/Sub OIDC</h4>
                        <p>Mensajes autenticados con OIDC token. Verificacion de service account.</p>
                        <h4>Connection Pool</h4>
                        <pre><code>jdbc.min-size=2
jdbc.max-size=20
jdbc.max-lifetime=PT5M  # Cloud SQL cierra idle en ~10min
jdbc.background-validation-interval=PT2M</code></pre>
                    </div>
                </section>
                <footer style="margin-top: 60px; padding: 32px 0; border-top: 1px solid var(--border); text-align: center;">
                    <p style="color: var(--text-secondary); font-size: 13px;">PilasFi Documentation 2025 | <a href="https://pilasfi.com" style="color: var(--accent);">pilasfi.com</a></p>
                    <p style="color: var(--text-secondary); font-size: 11px; margin-top: 6px;">Ramas: feat/new-backend-architecture, feature/newarch, feature/fixandres</p>
                </footer>
            </main>
        </div>
    </div>
</body>
</html>
